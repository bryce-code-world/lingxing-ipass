# Go 服务开发规范

适用范围：Go 微服务/作业/后台工具。目标：让日常开发遵循《软件开发价值观》和《软件开发原则》，特别是各分类的红线。

## 总体红线（全局适用）
- 必须：跨服务通过契约（API/proto/DTO），不共享 internal/model/pb。
- 必须：先契约后实现，默认向后兼容，破坏性变更要版本化/灰度/回滚方案。
- 必须：代码/配置可读可测；入/出库、消息前做校验；自动化门禁（gofmt/goimports/lint/test）通过才上线；关键决策要有 ADR。
- 必须：所有外部调用设超时、有限重试且幂等。
- 禁止：盲重试、复杂技巧遮蔽意图。

## 开发流程（框架）
1) 立项&类型 → 选服务类型、目录模板、基础依赖。
2) 数据草稿 → 领域/用例画实体、主索引、关键字段（先不落地 SQL）。
3) 契约草稿 → 基于数据草稿推导 API/gRPC/事件契约、错误语义、兼容策略。
4) 契约+数据评审 → 对齐字段/类型/单位/约束/默认值/兼容；定选库、表/索引、迁移计划、类型映射。
5) 目录落地 → 按类型套模板，生成样板。
6) 编码&测试 → 按编码规范+测试金字塔，CI 绿灯。
7) 观测&可靠性 → 指标/日志/追踪、超时/重试/熔断/幂等、健康检查。
8) 发布&运维 → 变更清单、灰度/开关、回滚预案、演练。

## 1. 项目结构与边界
- 目录与可见性
  - 必须：`cmd/<service>` 入口；`internal/<domain>` 私有；`pkg/` 稳定复用库；`api/` 契约；`configs/` 配置；`scripts/` 工具；`deploy/` CI/CD；`migrations/` 迁移。
  - 必须：`internal` 不跨服务依赖；公共库放 `pkg` 并版本化。
  - 必须：文件名/目录名使用小写字母+下划线。
  - 禁止：跨服务引用他人 `internal`/model/pb。
- 职责与依赖方向
  - 必须：模块/包单一职责；接口/用例层不依赖具体实现，适配器依赖接口。
  - 可选：抽象仅在 2+ 实现或明确变化点时做。

## 2. 契约与类型
- 策略与兼容
  - 必须：契约先行并评审；新增优先；删除/修改需版本化+灰度+观测窗口。
  - 必须：字段类型 API/proto/DB/消息一致；错误码/错误类型/重试语义统一且文档化；契约版本化可查废弃路径。
- 命名与格式
  - 必须：REST/OpenAPI `operationId` 用小驼峰的名词或名词短语；gRPC RPC 方法名用帕斯卡命名（大驼峰，例如 `GetUser`、`CreateOrder`）；消息 Topic 名用帕斯卡命名。
  - 必须：对外请求/响应字段使用小写字母+下划线（例如 `user_id`、`created_at`）。
  - 禁止：动词、复数、缩写、特殊符号、空格、下划线（除对外字段采用下划线格式的要求）。
- 时间与 ID
  - 必须：时间用 UTC `time.Time` 或 int64(ms/ns) 并标单位。
  - 必须：ID 选型前置（UUIDv4/雪花），索引/存储评审。
  - 禁止：时间传字符串不带时区/单位；自增 ID 暴露为对外标识。
- 字段类型与精度
  - 必须：金额用 DECIMAL(18,2) 或更高精度，不用 float/double；布尔用 bool/TINYINT(1)；枚举用小整数或字符串并列出取值。
  - 必须：数量/计数用 int64；时间戳用 int64(ms/ns) 或时间类型且注明单位。
  - 必须：字符串字段长度受控（如 VARCHAR(N)）；大文本用 TEXT 但评估索引策略。
  - 禁止：使用未限定精度/长度的类型；滥用 JSON 字段替代表设计。

## 3. 编码与实现
- 格式与命名
  - 必须：gofmt/goimports；包/文件小写；内部变量/参数/模型字段使用驼峰（导出首字母大写，包内首字母小写）；接口用行为名（Doer），实现用具体名；一函数一职责；常量使用全大写字母+下划线。
  - 禁止：模糊/无意义命名、缩写堆砌。
- 结构与复杂度
  - 必须：使用 guard clause，if/else 深度 ≤ 2；分支多用表驱动/策略模式。
  - 禁止：深层嵌套、在同层混合多职责。
- 依赖与上下文
  - 必须：依赖显式注入；跨边界传 `context.Context`，不得存全局。
  - 禁止：全局可变单例渗透业务。
- 副作用与分层
  - 必须：IO/网络在适配层，核心尽量纯；repo 方法一事一责；logic 只注册 `repo *repo.Repo`，各 repo 在 provider 注册。
  - 禁止：业务层直接操作全局资源。
- 错误处理
  - 必须：显式返回错误并包上下文；区分可重试/不可重试；不得 `_ = err` 吞错。
  - 禁止：裸 panic；无上下文的 `if err != nil { return }`。
- 日志与指标
  - 必须：结构化日志，避免敏感；高 QPS 采样；关键路径暴露 QPS/延迟/错误率 + trace。
  - 禁止：打印敏感信息、日志风暴。
- 并发
  - 必须：goroutine 有退出（ctx/chan）；避免泄漏；channel 容量合理。
  - 禁止：无限制开启 goroutine、共享可变数据不加保护。
- 配置与安全
  - 必须：配置文件/环境变量，默认安全；热更新需验证+回滚策略。
  - 禁止：硬编码密钥/证书。

## 4. 数据访问
- 命名与结构
  - 必须：表/字段名小写下划线、名词（可带形容词）；必有 created_at/updated_at/is_delete/deleted_at。
  - 禁止：拼音、特殊符号、空格、关键字。
- 契约与校验
  - 必须：入/出库、消息发布前校验；对外交互使用 uuid，不用自增 id。
- 访问与事务
  - 必须：统一 ORM/SQL 工具；参数化/预编译，禁止拼接 SQL。
  - 必须：显式事务边界，必要时设超时，禁止长事务持锁。
- 索引与性能
  - 必须：针对主查询设计索引；预估扩张表提前索引；变更前评审。
- 迁移与注释
  - 必须：使用迁移工具；每次迁移有回滚脚本，演练后上线；表/字段必须加注释。
- 安全与备份
  - 必须：最小权限；敏感字段加密/脱敏；备份加密并定期恢复演练。

## 5. 运行与可靠性（含安全）
- 超时/重试/幂等
  - 必须：所有外部调用设超时；重试有限次、幂等、指数退避；写操作设计幂等键；补偿/重放必须幂等。
- 隔离/熔断/降级
  - 必须：对下游配置隔离（池/队列），提供降级；熔断快速失败。
- 健康/退出
  - 必须：区分 liveness/readiness；依赖不可用时 readiness fail；优雅退出（停流量、等待在途、清理资源）。
- 可观测性
  - 必须：关键路径指标/日志/追踪；定义 SLO/错误预算；无观测不上线。
- 安全
  - 必须：默认 TLS/证书校验、最小权限、密钥不落盘；日志/指标不泄露敏感。
- 演练
  - 必须：故障注入/回滚/灾备演练常态化；未演练的变更不上核心路径。

## 6. 自动化与交付
- 预提交/CI
  - 必须：gofmt/gofumpt、goimports、golangci-lint、单元/契约测试通过。
  - 必须：CI 跑 fmt/lint/test(-race)/构建/镜像扫描/部署前检查；构建产物可复现（版本号、commit）。
- 测试金字塔
  - 必须：单元测核心/错误路径；契约测接口契约；集成测关键链路（含 DB/缓存/消息）；端到端/回归测用户路径；并发敏感代码跑 `go test -race`。
- 变更与灰度
  - 必须：每次上线有变更清单、风险评估、回滚方案；重要功能灰度/特性开关。
- 环境一致性
  - 必须：开发/预发/生产同构；配置用环境覆盖，禁止硬编码。

## 7. 协作与治理
- 决策与记录
  - 必须：关键架构/选型/破坏性变更有 ADR，含回滚/验证方案。
- 完成定义与评审
  - 必须：DoD 含测试/文档/监控/安全/回滚检查；评审覆盖契约、边界、可靠性、安全、性能。
- 复盘
  - 必须：故障/回滚/性能事件后复盘并跟踪行动项。
- AI 使用
  - 必须：标注 AI 生成内容，人工校对，敏感数据不得输入/输出。

## 8. 参考价值观映射
- 边界/耦合/抽象：少即是多；可读性与一致性；清晰边界与故障隔离；可演进与可回滚。
- 契约/类型/数据：数据比代码更重要；可演进与可回滚；防御与安全默认。
- 运行/可靠性/安全：防御与安全默认；可靠性与可观测性。
- 自动化/交付/治理：自动化验证与交付；可演进与可回滚；用户/业务价值优先；性能与成本意识。
