# 第四章 配置设计

本文基于：
- `doc/DSCO同步领星设计文档/1.业务需求.md`
- `doc/DSCO同步领星设计文档/3.数据库设计.md`

目标：把“服务如何配置、配置放哪里、如何校验、如何热更新、如何被任务使用”写清楚。

## 1. 配置分层与存放位置

本项目配置分两层：

1) **基础启动配置（env.yaml + 环境变量覆盖）**
- 用途：把服务启动起来，并承载“与部署强绑定”的配置（端口、环境、数据库、日志、Admin 密码、导出目录等）。
- 存放：仓库根目录 `env.yaml`。
- 覆盖：同名环境变量可覆盖 `env.yaml`（便于部署/容器化）。

2) **业务运行时配置（PostgreSQL 表 `runtime_config`）**
- 用途：业务运行过程中的可变配置（任务周期/批大小、DSCO/领星侧业务编码、运行时 token、映射配置等）。
- 存放：PostgreSQL 表 `runtime_config`，按 `domain` 区分业务领域配置（当前一期：`domain=dsco_lingxing`）。
- 修改入口：Admin 后台配置页面/接口（保存即生效）。

约束（已确认）：
- 服务内部统一用 UTC 时间戳；Admin 展示时区由 `env.yaml` 的 `admin.display_timezone` 控制，仅影响展示。
- 任务启动时获取一次“业务运行时配置快照”，本次执行全程使用同一快照；配置更新仅影响下一次执行。

## 2. 基础启动配置（env.yaml）

### 2.1 顶层分组（必须按类型拆开）

env.yaml 顶层按类型拆分为 6 类：

- `base`：基础（监听端口/服务环境）
- `integration`：集成固定配置（DSCO/领星 endpoint、业务编码、发货口径等；不从 Admin 修改）
- `db`：数据库（对齐 `golibv2/v2/tool/db/gormx.Config` 结构）
- `admin`：Admin（单密码、导出 CSV 相关配置）
- `log`：日志（对齐 `golibv2/v2/tool/logger.Config` 结构）
- `auth`：长期有效的鉴权密钥（DSCO token、领星 app_id/app_secret 等；不允许在 Admin 后台修改）

### 2.2 base（基础配置）

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `base.listen_addr` | string | 是 | HTTP 监听地址，例如 `0.0.0.0:8080` |
| `base.env` | string | 是 | 服务环境：`dev`/`test`/`release` |

### 2.3 auth（鉴权密钥，长期有效）

约束（已确认）：
- 领星 `app_id/app_secret` 与 DSCO 的 `token` 为长期有效，放在 `env.yaml`（以及可选的环境变量覆盖）中。
- 这类字段属于“部署级机密”，不允许在 Admin 后台修改。

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `auth.dsco.token` | string | 是 | DSCO API 授权 token（长期有效） |
| `auth.lingxing.app_id` | string | 是 | 领星 API 授权 app_id（长期有效） |
| `auth.lingxing.app_secret` | string | 是 | 领星 API 授权 app_secret（长期有效） |

### 2.4 integration（集成固定配置）

这类配置属于“业务集成的固定参数”，一般不需要在 Admin 后台频繁调整；为降低运行时配置复杂度，统一放在 `env.yaml` 中：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `integration.dsco.base_url` | string | 否 | DSCO API Base URL（可选；为空则使用 SDK 默认 BaseURLProd） |
| `integration.lingxing.base_url` | string | 否 | 领星 API Base URL（可选；为空则使用 SDK 默认 BaseURLProd） |
| `integration.lingxing.platform_code` | int | 是 | 领星平台编码（与业务需求一致） |

> 说明：如果未来确实需要在 Admin 热更新这些字段，可再迁回 `runtime_config`；一期先保持简单。

补充说明（写死）：

- 领星 `store_id`：由 DSCO 订单 `dscoRetailerId`（或 channel 兜底）通过 `runtime_config.mapping.shop` 映射得到。
- 领星 WMS 查询 `sid`：由 DSCO 订单 `shippingServiceLevelCode`（或 requestedShippingServiceLevelCode 兜底）通过 `runtime_config.mapping.shipment` 映射得到（配置值为可解析为 int 的字符串）。

### 2.5 db（数据库配置，对齐 gormx.Config）

`db` 节点使用 `golibv2/v2/tool/db/gormx.Config` 的字段结构（yaml tag 对齐），当前用 PostgreSQL：

- `db.dsn`：若填写优先使用；否则使用 `db.postgres.*` 组装 DSN
- `db.postgres.*`：`host/port/user/password/dbName/sslMode/timeZone/...`
- `db.pool.*`：连接池
- `db.gorm.*`：GORM 开关
- `db.startupCheck.*`：启动连通性检查
- `db.logger.*`：GORM SQL 日志适配（写入 `golibv2/v2/tool/logger`）

> 说明：具体字段含义以 `golibv2/v2/tool/db/gormx/config.go` 为准，本章只规定“配置形态与放置位置”。

### 2.6 admin（后台配置）

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `admin.password` | string | 是 | Admin 单密码（用于登录 `/admin`） |
| `admin.display_timezone` | string | 是 | Admin 页面展示时区（仅展示，不影响内部 UTC 计算），例如 `UTC` / `Asia/Shanghai` |
| `admin.export.dir` | string | 是 | CSV 导出文件落地目录（部署机器本地磁盘） |
| `admin.export.max_range_days` | int | 是 | 最大导出时间范围（业务口径：365） |
| `admin.export.cleanup_threshold_bytes` | int64 | 是 | 导出目录总大小阈值（业务口径：100MB） |

### 2.7 log（日志配置，对齐 logger.Config）

`log` 节点对齐 `golibv2/v2/tool/logger.Config` 的字段语义：

- `dir`、`maxSizeMB`、`maxBackups`、`maxAgeDays`、`compress`、`stdout`

> 说明：当前 logger 实现默认强制 `Stdout=true`（便于容器采集），但仍保留字段以便未来演进与文档一致性。

### 2.8 env.yaml 示例

```yaml
base:
  listen_addr: "0.0.0.0:8080"
  env: "dev" # dev/test/release

auth:
  dsco:
    token: "dsco_token_here"
  lingxing:
    app_id: "lingxing_app_id_here"
    app_secret: "lingxing_app_secret_here"

integration:
  dsco:
    base_url: "https://api.dsco.example.com"
  lingxing:
    base_url: "https://openapi.lingxing.com"
    platform_code: 0

db:
  dsn: "" # 优先使用；为空则用 postgres 组装
  postgres:
    host: "127.0.0.1"
    port: 5432
    user: "postgres"
    password: "postgres"
    dbName: "ipass"
    sslMode: "disable"
    timeZone: "UTC"
    clientEncoding: "UTF8"
    searchPath: "public"
    connectTimeout: "5s"
    statementTimeout: "0s"
    applicationName: "lingxing-ipass"
    preferSimpleProtocol: false
    params: {}
  pool:
    maxOpenConns: 30
    maxIdleConns: 10
    connMaxLifetime: "30m"
    connMaxIdleTime: "5m"
  gorm:
    skipDefaultTransaction: true
    prepareStmt: false
  startupCheck:
    enabled: true
    timeout: "5s"
  logger:
    enabled: true
    level: "warn"
    slowThreshold: "1s"
    ignoreRecordNotFoundError: true

admin:
  password: "change_me"
  display_timezone: "UTC"
  export:
    dir: "./exports"
    max_range_days: 365
    cleanup_threshold_bytes: 104857600

log:
  dir: "./logs"
  maxSizeMB: 128
  maxBackups: 300
  maxAgeDays: 7
  compress: false
  stdout: true
```

## 3. 业务运行时配置（runtime_config）

### 3.1 表结构与 domain 约定

运行时配置落在 PostgreSQL 表 `runtime_config`：

- `domain`：业务领域标识（字符串）；同一 `domain` 仅保留 1 份“当前生效配置”。
- 当前一期固定使用：`domain=dsco_lingxing`（DSCO ↔ 领星）。

表结构详见：`doc/DSCO同步领星设计文档/3.数据库设计.md`。

### 3.2 dsco_lingxing 配置 JSON（建议结构与分类）

以下为建议的 JSON 结构（用于 `runtime_config.config`），字段可按实现迭代，但必须保持：
- 可校验（保存时校验，不允许带病生效）
- 可复制（便于备份/迁移/排错）

```json
{
  "domain": "dsco_lingxing",
  "jobs": {
    "pull_dsco_orders": { "enable": false, "cron": "0 */15 * * * *", "size": 200 },
    "push_to_lingxing": { "enable": false, "cron": "0 */15 * * * *", "size": 50 },
    "ack_to_dsco": { "enable": false, "cron": "0 */15 * * * *", "size": 200 },
    "ship_to_dsco": { "enable": false, "cron": "0 */15 * * * *", "size": 200 },
    "invoice_to_dsco": { "enable": false, "cron": "0 */15 * * * *", "size": 50 },
    "sync_stock": { "enable": false, "cron": "0 0 0 * * *", "size": 200 },
    "cleanup_exports": { "enable": true, "cron": "0 0 */1 * * *", "size": 1 }
  },
  "mapping": {
    "shop": {},
    "warehouse": {},
    "sku": {},
    "shipment": {}
  }
}
```

字段说明（关键口径）：
- `jobs.*.cron`：cron 表达式（UTC 时区）；建议使用 6 段（含秒）格式，例如 `0 */15 * * * *`。
- `jobs.*.size`：单次执行处理的最大条数上限（所有任务统一都有该字段）。
- `mapping.shop`：店铺/渠道 ID 映射（key/value 都按字符串处理）。
- `mapping.warehouse`：仓库 ID 映射（key/value 都按字符串处理）。
- `mapping.sku`：SKU 映射（key/value 都按字符串处理；缺省可按“同名直传”处理）。
- `mapping.shipment`：物流方式映射（key/value 都按字符串处理）。
- 任务不允许并发执行同一 job（定时/手动共享互斥）。

### 3.2.1 配置项逐项说明（必须在文档中定死）

#### 1) 顶层字段

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `domain` | string | 是 | 业务领域标识，用于 `runtime_config.domain` 的分区；一期固定为 `dsco_lingxing` |
| `jobs` | object | 是 | 任务调度与批大小配置集合（每个任务一个节点） |
| `mapping` | object | 是 | 业务映射集合（店铺/仓库/SKU/物流方式） |

> 约束：`runtime_config` 只存“可频繁调整”的运行时配置；`env.yaml` 的 `integration/*` 与 `auth/*` 属于部署级固定配置，不从 Admin 热更新。

#### 2) jobs（任务调度配置）

`jobs` 下每个任务节点结构一致：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| `jobs.<job>.enable` | bool | 是 | 是否纳入定时调度；`false` 表示不定时触发（手动触发是否包含由 Admin 交互定义，建议默认仅触发 enable=true 的任务） |
| `jobs.<job>.cron` | string | 是 | cron 表达式（UTC 时区） |
| `jobs.<job>.size` | int | 是 | 单次执行处理条数上限（分页大小/批量大小的统一口径） |

cron 推荐使用 6 段（含秒）的格式：

```
秒 分 时 日 月 周
```

常用示例（UTC）：

| 需求 | cron 示例 |
| --- | --- |
| 每 15 分钟执行一次 | `0 */15 * * * *` |
| 每小时第 5 分钟执行 | `0 5 * * * *` |
| 每天 00:00 执行 | `0 0 0 * * *` |

> 约束：实现侧必须选用支持“秒级 cron”的解析器（6 段），否则该配置格式不成立。

任务清单（一期 DSCO ↔ 领星）：

| job 名称 | 用途 | size 口径 | size 建议（可调） |
| --- | --- | --- | --- |
| `pull_dsco_orders` | 拉取 DSCO 订单入库（按 `created_at` + `[start,end)`） | 单次拉取 DSCO 订单最大条数（分页/游标由实现决定） | 200 |
| `push_to_lingxing` | 将入库订单写入领星 | 单次写入领星的最大订单数 | 50 |
| `ack_to_dsco` | 领星状态满足条件后回传 ACK | 单次回传 ACK 的最大订单数 | 200 |
| `ship_to_dsco` | 回传物流信息 | 单次回传物流的最大订单数 | 200 |
| `invoice_to_dsco` | 回传发票信息 | 单次回传发票的最大订单数 | 50 |
| `sync_stock` | 库存同步 | 单次同步的最大 SKU 数（或明细条数；以实现落地为准） | 200 |
| `cleanup_exports` | 清理导出目录 | 不使用（占位；仍需为正整数） | 1 |

> 说明：
> - `size` 不是“必须处理满额”，而是“最多处理多少条”，用于控制单次执行耗时与外部 API 压力。
> - 任务执行时使用同一份配置快照；修改配置只影响下一次执行（定时触发或手动触发）。

#### 3) mapping（业务映射配置）

`mapping` 用于把 DSCO 与 领星侧的“标识/编码”关联起来，所有 key/value 都按字符串处理。

约束（写死）：

- **mapping 统一用 DSCO 的标识/编码映射到领星**（即 key 为 DSCO，value 为 领星），避免“同一配置里方向混用”造成误配。
- 若某些任务需要反向映射（领星 → DSCO），实现侧只能在内存中构建**反向 map**，并在发现一对多/多对一冲突时视为配置错误（拒绝保存或拒绝启用相关任务）。

| 字段 | 类型 | 必填 | 映射方向（约定） | 说明 |
| --- | --- | --- | --- | --- |
| `mapping.shop` | object(map) | 是 | DSCO dscoRetailerId（或 channel） → 领星 store_id（字符串） | 推单到领星必需（用于确定 StoreID）；同时该值会用于 WmsOrderList 的 `sid_arr`（需能解析为 int） |
| `mapping.warehouse` | object(map) | 是 | DSCO warehouseCode → 领星仓库 ID（WID） | 库存同步必需；key/value 都是字符串（例如 value 为 `"26"`） |
| `mapping.sku` | object(map) | 否 | （一期不使用） | 一期确认：推单到领星时 SKU 不做映射，直接将 DSCO SKU 赋值到领星建单参数 `msku`，由领星侧自动匹配 |
| `mapping.shipment` | object(map) | 是 | DSCO `<shipWarehouseCode>-<shippingServiceLevelCode>` → 领星 `logistics_type_id` | 推单到领星时用于填写 `logistics_type_id`（当填写 wid 时必填）；若 `shipWarehouseCode` 为空，可用 `requestedWarehouseCode` 兜底生成 key |

映射示例：

```json
{
  "mapping": {
    "shop": {
      "dsco_channel_1": "10001"
    },
    "warehouse": {
      "US_WEST_01": "26"
    },
    "sku": {
      "DSCO-SKU-001": "LX-SKU-001"
    },
    "shipment": {
      "YQN-CA-FEHD": "203662740883276800"
    }
  }
}
```

### 3.2.2 完整示例（可直接保存到 runtime_config.config）

> 说明：下面示例仅演示“结构与配置口径”，具体 cron 与 size 可按实际压力调整。

```json
{
  "domain": "dsco_lingxing",
  "jobs": {
    "pull_dsco_orders": { "enable": true, "cron": "0 */15 * * * *", "size": 200 },
    "push_to_lingxing": { "enable": true, "cron": "0 */15 * * * *", "size": 50 },
    "ack_to_dsco": { "enable": true, "cron": "0 */15 * * * *", "size": 200 },
    "ship_to_dsco": { "enable": true, "cron": "0 */15 * * * *", "size": 200 },
    "invoice_to_dsco": { "enable": true, "cron": "0 */15 * * * *", "size": 50 },
    "sync_stock": { "enable": true, "cron": "0 0 0 * * *", "size": 200 },
    "cleanup_exports": { "enable": true, "cron": "0 0 */1 * * *", "size": 1 }
  },
  "mapping": {
    "shop": {},
    "warehouse": { "US_WEST_01": "26" },
    "sku": {},
    "shipment": {}
  }
}
```

### 3.2.3 配置建议（经验值）

- `pull_dsco_orders/push_to_lingxing/ack_to_dsco/ship_to_dsco/invoice_to_dsco`：建议 cron 不小于 5 分钟，避免外部 API 压力过大；`size` 从小到大逐步放量。
- `sync_stock`：建议每日 1 次（例如 `0 0 0 * * *`）起步；如需更频繁，优先降低 `size` 控制单次耗时。
- `cleanup_exports`：建议每小时或每日执行一次（例如 `0 0 */1 * * *`）；阈值与目录由 `env.yaml admin.export.*` 决定。
- 当出现接口限流/超时：优先降低对应任务 `size` 或拉长 cron 周期，再观察稳定性。

### 3.3 必填与启用条件（保存时校验）

保存运行时配置时必须校验：

- JSON 合法。
- `domain` 必须是已支持的领域（一期：仅 `dsco_lingxing`）。
- `jobs.*.cron` 必须是可解析的 cron 表达式；`jobs.*.size` 必须为正整数。
- `jobs` 仅允许出现已支持的 job 名称（一期见本章“任务清单”）；出现未知 job 直接拒绝保存（避免“配了但不生效”）。
- 各任务开关的“启用依赖”：
  - 启用任何 DSCO 相关任务前：`integration.dsco.base_url`（env.yaml）与 `auth.dsco.token`（env.yaml）必须存在。
  - 启用任何领星相关任务前：`integration.lingxing.base_url`、`integration.lingxing.platform_code`（env.yaml）以及 `auth.lingxing.app_id/auth.lingxing.app_secret`（env.yaml）必须存在。
  - 启用 `push_to_lingxing` 前：`mapping.shop` 必须能覆盖 DSCO 订单的 `dscoRetailerId`（或 channel 兜底），否则该订单推单会被跳过并记录日志。
  - 启用 `ship_to_dsco`/`invoice_to_dsco` 前：`mapping.shipment` 必须能覆盖 DSCO 订单的 `shippingServiceLevelCode`（用于映射到领星 SID），否则该订单会被跳过并记录日志。
  - 启用库存同步任务前：`mapping.warehouse` 必须非空。
> 说明：敏感字段（`auth.*`）不进入 Admin 配置页面，仅通过部署配置管理。

## 4. 加载流程与热更新

### 4.1 启动加载顺序

1. 读取 `env.yaml`（再用环境变量覆盖同名字段）。
2. 初始化日志（`golibv2/v2/tool/logger`）。
3. 连接 PostgreSQL（GORM，优先复用 `golibv2/v2/tool/db/*`）。
4. 从 `runtime_config` 读取 `domain=dsco_lingxing` 的配置：
   - 若不存在：插入一条默认配置（任务全部关闭、`mapping.*` 为空），等待 Admin 配置完善后启用任务。
5. 启动 HTTP（含 `/admin`）与定时触发器（scheduler）。

### 4.2 热更新与配置快照

- Admin 保存配置后：写入 `runtime_config.config` 并更新 `updated_at`（UTC 秒级时间戳），立即替换内存中的“当前配置”。
- 任务执行前：从内存“当前配置”取一次快照，整个任务执行过程只使用该快照。

## 5. 与任务/导出相关的配置约束

### 5.1 不允许并发

- 同一任务不允许并发执行（定时/手动共享互斥）。
- 若任务运行中再次触发：直接拒绝（返回错误/提示）。

### 5.2 导出文件与清理

- CSV 导出：生成文件并立即下载（接口超时设置更大）。
- 文件落地目录：`admin.export.dir`（部署机器本地磁盘）。
- 清理：由后台清理任务执行；当目录总大小超过 `admin.export.cleanup_threshold_bytes`（100MB）时，按“最旧优先”删除导出文件。
