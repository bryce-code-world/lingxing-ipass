# DSCO 同步领星：业务需求（订单 / 库存）

关联文档：`doc/一期系统设计文档/1. 一期业务需求（DSCO-领星自动化）.md`

说明：
- 本文定义业务需求（含 Admin 后台能力），并以当前代码实现为准持续迭代。
- 文中出现的表名/字段名（例如 `dsco_order_sync`、`dsco_warehouse_sync`）以当前实现与 `migrations/init.sql` 为准。

## 0. 总体约束（本期强约束）

### 0.1 单服务形态

- Admin 后台与业务不再拆分为两个服务/两个进程：统一在一个服务内提供能力。
- Admin 相关资源统一放在 `admin/` 目录（页面、静态资源、模板、以及 admin 的 handler 代码等）。
- Admin 相关接口统一以 `/admin` 前缀对外提供（UI 与 API 均如此）。

### 0.2 数据库

- 数据库使用 PostgreSQL（一期）。

### 0.3 时间与时区

- 服务内部所有时间统一使用 UTC 时区（存储/计算/对外请求）。
- Admin 后台展示时间可配置显示为 UTC 或其他时区（仅影响展示，不影响存储与任务执行）。

## 1. 背景与目标

需要把 DSCO（以 Chewy 订单为主）与领星之间的订单与库存信息做闭环同步：

- 订单：DSCO 订单 -> 领星下单/同步 -> DSCO ACK -> DSCO 回传物流 -> DSCO 回传发票（完成态）
- 库存：每日对账领星与 DSCO 库存，有差异则回写 DSCO，并记录日志

## 2. 范围与非范围（一期）

### 2.1 范围内

- 订单同步闭环：拉取 DSCO 订单原始数据、同步到领星、ACK、回传物流
- 库存同步：按“仓库 + SKU”维度对账并更新 DSCO 库存，写入同步日志
- 幂等要求：所有“写”操作必须先检查再执行，允许重复执行但结果一致

### 2.2 非范围（按当前原始需求明确不做）

以下“能力”在原始描述中明确倾向不做或不强调（需要进一步确认是否真的完全不做）：

- 不引入额外的重试机制/复杂错误处理/监控告警/数据补偿流程（失败跳过，下次定时任务自然重跑）

> 说明：即使“不做补偿/监控”，也仍需要有基础日志，便于定位失败原因与人工介入。

## 3. 术语与对象

- DSCO 订单：从 DSCO 侧拉取的订单（本文以 `po_number` 作为订单号/唯一键口径）
- 领星订单：写入/查询领星后的订单实体（具体字段以 SDK/接口为准）
- 订单同步状态：本地同步表中记录的处理阶段（见下文状态机）
- 仓库 + SKU 表：库存同步所依赖的遍历集合（来源/维护方式待明确）

## 4. 订单同步闭环

### 4.1 状态机定义

订单在本地表 `dsco_order_sync` 中用 `status` 字段表示同步阶段：

- `1`：待推单到领星（已拉取 DSCO 原始订单数据）
- `2`：待 ACK 回传（已写入领星）
- `3`：待回传物流（shipment）（DSCO 已确认，等待发货信息回传）
- `4`：待回传发票（invoice）（已回传物流，等待发票回传）
- `5`：完成（已回传发票；或拉单时 DSCO `dsco_status=shipped` 直接完成）
- `6`：已取消（DSCO `dsco_status=cancelled`）

可视化（概览）：

	```mermaid
	stateDiagram-v2
	  [*] --> 待同步: 拉取 DSCO 订单
	  待同步 --> 待确认: 同步到领星
	  待确认 --> 已确认: 领星已审核/已发货<br/>调用 DSCO ACK
	  已确认 --> 已发货: 领星已发货<br/>回传物流到 DSCO
	  已发货 --> 完成: 回传发票到 DSCO
	```

### 4.2 定时任务与顺序要求

原始描述定义了多阶段任务，目的是保证阶段顺序推进：

1. 拉取 DSCO 订单 -> 写入本地表，置为 `status=1`
2. `status=1` -> 同步到领星，置为 `status=2`
3. `status=2` -> 查询领星订单状态，满足条件则 DSCO ACK，置为 `status=3`
4. `status=3` -> 查询领星订单状态，已发货则回传物流到 DSCO，置为 `status=4`
5. `status=4` -> 组装发票数据，回传发票到 DSCO，置为 `status=5`

> 实现约束：无论具体调度周期如何，必须保证任务 2~5 的输入只来自“前置状态”的记录，且允许重复跑但不产生副作用。

### 4.3 任务 1：拉取 DSCO 订单并入库（生成待同步记录）

**触发**：定时 + Admin 手动触发（详见第 8 节）。  
**输入**：订单“最新时间”来自本地 `dsco_order_sync.dsco_create_time`（取最大值）。  
**动作**：从 DSCO 分页拉取订单（按 DSCO `created_at` 增量拉取），将关键字段与原始 JSON 保存到本地表；入库 `status` 由 DSCO 的 `dsco_status` 自动推导。  
**写入字段（任务 1 注入）**：

- `po_number`：DSCO 订单号（唯一键）
- `dsco_create_time`：DSCO 订单 `created_at`（仅使用 `dscoCreateDate`；UTC 秒级时间戳）
- `dsco_status`：DSCO 订单拉取时状态（例如 `created`、`shipment_pending`、`shipped`、`completed`、`cancelled`）
- `dsco_retailer_id`：DSCO `dscoRetailerId`（用于 mapping.shop 与筛选）
- `payload`：DSCO 订单原始 JSON（覆盖更新）
- `mskus`：订单 SKU 列表（从 DSCO 行项目提取；用于筛选/导出）
- `warehouse_id`：DSCO 仓库编码（用于 mapping.warehouse 与筛选/导出）
- `shipment`：DSCO 物流方式编码（取 `ShippingServiceLevelCode`；用于 mapping.shipment 与筛选/导出）

**幂等要求（以实现为准）**：同一个 `po_number` 多次拉取/入库采用 upsert 覆盖更新（覆盖 `payload` 与上述派生字段），不产生重复记录。

**水位/起始时间口径（已确认）**：

- 不单独存储“游标/水位”表：以 `dsco_order_sync.dsco_create_time` 的最大值作为下一次拉单起点。
- 若 `dsco_order_sync` 为空：以 `2025-01-01T00:00:00Z`（UTC）作为起始时间向后拉取。

**dsco_status -> status 推导规则（已确认）**：

- `created` -> `status=1`
- `shipment_pending` -> `status=3`
- `shipped` -> `status=5`
- `cancelled` -> `status=6`
- 其他/空值 -> `status=1`（按待推单处理）

### 4.4 任务 2：同步到领星（待确认 ack）

**触发**：定时 + Admin 手动触发（详见第 8 节）。  
**输入**：本地表 `status=1` 的 DSCO 订单记录。  
**动作**：将订单同步到领星后，置 `status=2`。  
**幂等要求**：写入领星前必须先检查（例如：领星侧是否已存在对应订单、或本地是否已完成该步骤），确保重复执行不产生多单/重复写入。

**唯一键/去重键口径（已确认）**：

- DSCO：`po_number` 为订单唯一键
- 领星：`platform_order_no` 对应 DSCO `po_number`，且为两边系统统一的订单唯一键

### 4.5 任务 3：ACK（确认 DSCO 订单）

**触发**：定时 + Admin 手动触发（详见第 8 节）。  
**输入**：本地表 `status=2` 的记录。  
**动作**：查询领星订单状态：若满足“可 ACK”，则调用 DSCO 订单 ACK API，置 `status=3`。  
**幂等要求**：调用 ACK 前必须检查 ACK 是否已完成（通过 DSCO 查询或本地已落库标记），避免重复 ACK 产生异常。

**可 ACK 状态口径（已确认）**：

领星订单 `status` 枚举：

```text
1 同步中
2 已同步
3 待付款
4 待审核
5 待发货
6 已发货
7 已取消/不发货
8 不显示
9 平台发货
```

- 当 `status` 为 `5`（待发货）或 `6`（已发货）时，可回传 ACK 给 DSCO。

### 4.6 任务 4：回传物流（批量）

**触发**：定时 + Admin 手动触发（详见第 8 节）。  
**输入**：本地表 `status=3` 的记录。  
**动作**：查询领星状态：若“已发货”，解析领星订单发货信息（含物流跟踪号等），调用 DSCO 物流批量同步接口；成功后置 `status=4`，并在本地记录：

- `shipped_tracking_no`：回传物流的跟踪号（任务 4 注入）

**幂等要求**：回传前必须检查该订单物流是否已回传过（通过 DSCO 查询或本地字段），重复执行结果一致。

**字段映射口径（已确认）**：

- 领星 `tracking_no` -> DSCO `trackingNumber`（必填：包裹物流跟踪号/运单号）
- 领星 `global_delivery_time` -> DSCO `shipDate`（发货日期，DSCO 要求 ISO 8601，例如 `YYYY-MM-DDTHH:MM:SSZ`）
- 领星 `logistics_type_name` -> DSCO `shipMethod`（配送服务方式/级别）

### 4.7 任务 5：回传发票（批量）

**触发**：定时 + Admin 手动触发（详见第 8 节）。  
**输入**：本地表 `status=4` 的记录。  
**动作**：结合 DSCO 原始订单与领星订单实际出库情况，拼装 invoice 发票数据，调用 DSCO 发票数据批量创建接口；成功后置 `status=5`，并在本地记录：

- `dsco_invoice_id`：回传发票生成的发票 ID（任务 5 注入）

**幂等要求**：创建发票前必须检查发票是否已创建（通过 DSCO 查询或本地字段），重复执行不应创建多张发票。

**数据来源口径（已确认）**：

- 发票字段（币种/订单关联/明细标识等）可从 DSCO 原始订单获取。
- SKU 实际发货数量与订单总金额：以领星订单 API 返回的数据为准（需要查询领星订单实际出库/发货情况后再生成发票）。

**字段映射（示例，图 1 对应口径）**：

| 字段类别 | DSCO 原始订单字段 | 映射到回传发票字段 |
| --- | --- | --- |
| 订单关联 | `poNumber` | `poNumber` |
| 商品识别 | `lineItems[].partnerSku` | `lineItems[].partnerSku` |
| 商品识别 | `lineItems[].dscoItemId` | `lineItems[].dscoItemId` |
| 财务背景 | `currencyCode` | `currencyCode` |

### 4.8 失败处理与重跑口径

原始口径：

- 所有失败订单：本轮直接跳过
- 下次定时任务会再次扫描并重试（自然重跑）
- 不做额外的重试机制、复杂错误处理、监控、数据补偿

最低可落地要求（不改变原口径前提下）：

- 每个任务对失败的订单必须有可检索日志（至少包含 `po_number` 与失败原因）
- 任务批量接口出现部分失败时：必须保证成功的记录能推进状态，失败记录留在原状态等待下次处理

### 4.9 初始化/人工触发口径（必须支持）

一期明确需要通过 Admin 后台支持“手动拉单入库”，以覆盖初始化与紧急同步两类场景：

1. **初始化**：通过人工指定 DSCO 订单创建时间范围，拉取订单入库（避免服务启动时默认全量拉取带来的风险）。
2. **紧急同步**：若业务需要立即处理某时间段订单，可再次手动拉取该时间段订单入库。

手动拉单入库时，不再支持传入/选择入库 `status`：入库 `status` 由 DSCO 的 `dsco_status` 自动推导（见下文“dsco_status -> status 推导规则”）。如需人工调整同步阶段，使用 Admin 订单列表的“编辑 status”能力。

## 5. 库存同步

### 5.1 同步规则（每日）

**触发**：定时（每日）。  
**输入**：按“仓库 + SKU 表”遍历的集合。  
**动作**：获取领星库存与 DSCO 库存；若有差异，则执行库存更新，并记录库存更新日志。

> 说明：差异判断口径、取数接口与更新接口字段，以 SDK 文档为准。

## 6. 配置开关要求

原始口径：“所有任务，都要有一个配置开关”。一期需求至少需要支持：

- 订单同步任务 1~4（+可选 invoice）分别可开/可关（避免未确认前误跑）
- 库存同步任务可开/可关
- 初始化/人工触发（若保留）可开/可关

补充（Admin 能力）：

- 管理员可在 Admin 后台直接修改服务配置（详见第 8 节），用于：开关任务、调整周期、调整映射配置、修改外部系统连接信息等。

## 7. 验收标准（最小集合）

### 7.1 订单链路

- 任务 1 能分页拉取 DSCO 订单并落到本地状态库，进入“待同步”阶段
- 任务 2 能把“待同步”推进到“待确认（ack）”
- 任务 3 在领星订单满足“已审核/已发货”条件时，能 ACK DSCO 并推进到“已确认”
- 任务 4 在领星订单“已发货”时，能回传物流并推进到“已发货”
- 任务 5 能回传发票并推进到“已创建发票（完成态）”
- 幂等：任一任务对同一订单重复执行不会产生重复写入/重复回传/状态回退
- 失败重跑：单个订单失败不会阻塞其他订单推进；失败订单可在下一轮再次处理

### 7.2 库存链路

- 每日任务能遍历“仓库 + SKU 表”，比较领星与 DSCO 数量
- 有差异时能更新 DSCO 库存，并记录一条可追溯日志
- 失败时有明确失败原因可定位问题

## 8. Admin 后台业务需求

### 8.1 配置管理（可在线修改服务配置）

管理员在 Admin 后台可查看/修改服务配置，至少包括：

- 业务领域配置（runtime_config）：任务开关与 cron/批大小、映射类配置（以 JSON 形式录入，便于复制与回滚）

约束：

- 修改必须做校验：JSON 合法性、必填项完整性、取值范围合法性；校验失败不得保存/不得生效。
- 敏感字段（token 等）展示需脱敏；修改应支持“保持不变”的交互（不强制重新输入）。
- 配置保存即生效（热更新）。
- 管理员权限模型：单密码（密码由 env 配置）。
- env 仅配置“基础启动配置 + 授权信息”（例如端口、数据库 DSN、Admin 密码、领星 app_id/app_secret、DSCO token 等）；业务运行过程中的任务与映射配置统一在 Admin 后台配置并热更新。

### 8.2 手动拉取 DSCO 订单入库（按创建时间范围）

管理员可在 Admin 后台手动发起“拉取 DSCO 订单入库”任务，输入：

- DSCO 订单创建时间范围：`start`、`end`

输出（以实现为准）：

- 接口返回成功/失败；失败原因在日志中排查（一期不做任务执行审计表）

幂等与覆盖策略（以实现为准）：

- 若订单已存在：覆盖更新 `payload`、`dsco_status`、派生字段，并按 `dsco_status` 重新推导入库 `status`。
- 如需人工调整同步阶段，使用 Admin 订单列表的“编辑 status”能力。

**时间字段口径（已确认）**：

- 手动拉单与定时拉单，均以 DSCO 订单 `created_at` 为准进行拉取。
- 时间范围与服务内部计算均为 UTC 时区。
- 时间范围边界：采用 `[start,end)`（包含 `start`，不包含 `end`）。

### 8.3 手动触发所有任务执行

管理员可在 Admin 后台手动触发以下任务执行（可单个触发，也可一键触发全部）：

- 订单同步任务 1~4（+可选 invoice）
- 库存同步任务

要求：

- 任务执行要有可见的返回结果（成功/失败、耗时、错误信息）。
- 若任务正在运行，重复触发的行为需要定义（拒绝/排队/合并/允许并发）。

**并发口径（已确认）**：

- 不允许并发执行同一任务；若任务正在运行，手动触发应直接拒绝执行并返回错误。
- 失败处理：失败订单/失败项直接跳过，等待下一次定时任务自动重试。

### 8.4 `dsco_order_sync` 查询与导出 CSV

Admin 后台支持对 `dsco_order_sync` 的列表查询，并支持导出 CSV：

- 多条件筛选（至少支持：`po_number`、创建时间范围、状态、仓库、SKU、物流跟踪号、发票 ID 等）
- 支持分页、排序
- 导出 CSV：以“当前筛选条件”为范围导出

补充（一期最新确认）：

- Orders 列表支持对**单个订单**按当前 `status` 执行对应任务（仅处理该 `po_number`，不影响其他订单；`status=5/6` 禁用）。

约束：

- 导出时间范围最大允许 1 年。
- 导出生成 CSV 文件并立即下载；相关接口超时时间设置更大（避免导出过程中断）。

### 8.5 `dsco_warehouse_sync` 查询与导出 CSV

Admin 后台支持对 `dsco_warehouse_sync` 的列表查询，并支持导出 CSV：

- 多条件筛选（至少支持：同步时间范围、DSCO 仓库、SKU、同步状态、失败原因关键字等）
- 支持分页、排序
- 导出 CSV：以“当前筛选条件”为范围导出

约束（与订单导出一致）：

- 导出时间范围最大允许 1 年。
- 导出生成 CSV 文件并立即下载；相关接口超时时间设置更大（避免导出过程中断）。
