# DSCO 同步领星系统说明文档（业务版）

最后更新：2026-02-04  
适用范围：一期 `dsco_lingxing` 领域（DSCO ↔ 领星）

> 本文面向业务人员，用于说明：系统自动化覆盖哪些流程、什么时候执行、延迟口径、哪些情况属于异常/不处理范围。  
> 本文不包含操作手册（业务侧不需要操作），也不作为接口字段的最终裁决（字段争议以 SDK 文档为准）。

---

## 1. 一句话结论（先读这个）

1) **系统是“定时批处理”，不是实时系统**：所有流程由定时任务触发，延迟受“任务周期 + 外部系统处理耗时 + 积压量”影响。  
2) **系统按“分阶段”推进**：订单会按固定阶段推进；任何阶段的前置条件不满足，会“跳过并等待下次再试”。  
3) **异常通常表现为“长时间停留在某一阶段”**：若同一订单在某阶段持续多个任务周期仍未推进，通常是异常（常见原因见第 4 章）。

---

## 2. 自动化覆盖流程一览（业务关心的“覆盖了什么”）

说明：
- 每个流程对应一个或多个后台任务（job）。job 的执行时间由运行时配置 `runtime_config.jobs.<job>.cron` 决定（**时区固定 UTC**）。
- DSCO 的部分批量接口为异步处理：系统“发起成功”不等于 DSCO 侧立刻可见（延迟口径见第 3 章）。

| 业务流程 | 方向 | 对应 job（系统内部名） | 自动执行时机 | 产出/影响 | 何时算异常（业务视角） |
| --- | --- | --- | --- | --- | --- |
| 订单拉取入库 | DSCO → 本系统 | `pull_dsco_orders` | 按 cron 周期增量拉取；首次启动会从固定起点开始 | 订单进入“待推单”队列（分阶段推进的起点） | DSCO 已有订单，但长时间未进入后续推单/回写链路 |
| 推单到领星 | 本系统 → 领星 | `push_to_lingxing` | 按 cron 周期处理“待推单”订单 | 领星生成订单（幂等：已存在则不重复创建） | DSCO 订单长时间未出现在领星或未进入后续阶段 |
| ACK 回传 | 领星/本系统 → DSCO | `ack_to_dsco` | 按 cron 周期处理“待 ACK”订单 | DSCO 侧 ACK（或判定 DSCO 已确认/更后阶段则直接推进） | 领星已审核/已出库，但 DSCO 长时间仍未确认 |
| 发货（Shipment）回传 | 领星 → DSCO | `ship_to_dsco` | 按 cron 周期处理“待回传发货”订单 | DSCO 侧更新运单/发货信息（tracking） | 领星已发货/有运单号，但 DSCO 长时间无 tracking/发货信息 |
| 发票（Invoice）回传 | 领星 → DSCO | `invoice_to_dsco` | 按 cron 周期处理“待回传发票”订单 | DSCO 侧生成/更新发票（按规则汇总） | 领星已全量发货，DSCO 长时间无发票信息 |
| 库存同步 | 领星 → DSCO | `sync_stock` | 按 cron 周期同步各仓库存可用量 | DSCO inventory 更新（可用库存） | 库存长期与领星差异显著且持续不收敛 |
| SKU 配对自动补丁 | 领星 → 本系统配置 | `pull_sku_pair` | 通常每日/每晚执行一次（按 cron） | 自动更新 `mapping.sku`（用于 SKU 映射）并产出审计文件 | 同一 MSKU/SKU 发生冲突导致自动任务终止（会影响后续映射准确性） |
| 导出文件清理（运维） | 本地 → 本地 | `cleanup_exports` | 按 cron 定期清理导出目录 | 仅影响导出文件占用空间，不影响业务数据 | 不属于业务异常（除非导出目录占满磁盘） |

---

## 3. “什么时候执行、延迟有多久”口径（业务解释版）

### 3.1 执行时机

- 系统按 `runtime_config.jobs.<job>.cron` 定时触发（cron 解析启用 seconds，**时区固定 UTC**）。
- 同一 job **不并发执行**：如果上一次还在跑，本次触发会被拒绝（避免重复写入/竞态）。
- 每次执行都有单次处理上限 `runtime_config.jobs.<job>.size`；当积压量很大时，可能需要多轮执行才能处理完，从而拉长延迟。

### 3.2 延迟口径（怎么理解“为什么不是立刻生效”）

延迟通常由三部分组成：

1) **等待下一次任务执行窗口**：例如 job 每 15 分钟跑一次，则新订单进入处理链路的“理论最短等待”约为 0~15 分钟。  
2) **系统处理耗时**：受批大小（`size`）、积压量、外部接口响应影响。  
3) **外部系统处理耗时**：
   - DSCO 的部分批量接口为异步（返回 requestId），DSCO 侧落地可能再延迟一段时间；
   - 领星侧“审核/出库/发货”属于业务流程本身，系统只能在这些状态出现后再推进后续回写。

因此：
- **单个阶段的典型延迟** ≈ 该阶段 job 的周期 + 当轮处理耗时 + 外部系统可见性延迟  
- **订单闭环总延迟** ≈ 各阶段延迟叠加（且受“前置条件是否满足”影响）

---

## 4. 订单闭环的规则与边界（业务最关心）

订单闭环是一个分阶段队列（内部状态机会从 1 推进到 5）。业务可按“卡在哪个阶段”判断大致原因。

### 4.1 阶段定义（概念）

| 阶段 | 含义（业务口径） | 触发/推进条件（摘要） | 对应 job |
| --- | --- | --- | --- |
| 1 | 已拉取入库，等待推单到领星 | DSCO 订单被拉取并入库 | `pull_dsco_orders` → `push_to_lingxing` |
| 2 | 已推到领星，等待 ACK 回 DSCO | 领星订单存在（或已存在则直接进入本阶段） | `ack_to_dsco` |
| 3 | 已 ACK（或判定 DSCO 已确认），等待回传发货信息 | 领星侧出现可回传的发货数据，且 DSCO 状态允许回传 | `ship_to_dsco` |
| 4 | 已回传发货，等待回传发票 | 领星侧全量发货完成（满足“全量发货”判断） | `invoice_to_dsco` |
| 5 | 完成 | 发票回传成功（或拉单时 DSCO 已 shipped 直接完成） | 无 |

> 备注：取消单会进入“取消”终态（不再推进）。

### 4.2 关键规则（写死的业务口径）

**R1：推单前置条件（缺失就不推）**
- 必须能从 `mapping.shop` 把 DSCO 的 `dscoRetailerId` 映射到领星 `store_id`，否则该订单会被跳过。
- 若需要指定领星仓库（WID），必须有 `mapping.warehouse` 映射；否则无法正确路由仓库。
- 若推单请求需要物流方式（`logistics_type_id`），必须有 `mapping.shipment` 映射（key 由仓库与 DSCO 的 shippingServiceLevelCode 组合而成）；缺失会跳过。
- DSCO 订单必须具备可用的收货地址与必填字段；缺失会跳过。

**R2：幂等（不会重复创建领星订单）**
- 以 `poNumber` 为幂等键：若领星已存在同 `poNumber` 订单，系统不会重复创建，而是直接推进到后续阶段。

**R3：ACK 回传规则（避免过早/重复 ACK）**
- 系统会先看 DSCO 订单状态：
  - 若 DSCO 已在 `shipment_pending` / `shipped` / `completed`，认为 DSCO 已确认或更后阶段：系统不会再 ACK，而是直接推进到下一阶段。
  - 其他状态才会尝试 ACK。
- 对仍需 ACK 的订单，要求领星侧状态满足“可 ACK”的条件（且同一 `poNumber` 拆成多子单时，需全部子单满足条件），否则跳过等待下次。

**R4：发货（Shipment）回传规则**
- 系统会先看 DSCO 订单状态：
  - 若 DSCO 已 `shipped` / `completed`：系统不会重复回传 shipment，而是直接推进，并尽量补齐 tracking（若 DSCO 有）。
  - 若 DSCO 为 `shipment_pending`：允许回传 shipment。
  - 其他状态：跳过（避免错误回传）。
- 发货数据来源于领星 WMS 出库列表：若领星侧缺少 tracking 或缺少可回传的明细，会跳过等待下次。
- tracking 可能有多个：系统会去重并用英文逗号拼接，仅用于展示与筛选。

**R5：发票（Invoice）回传规则（最容易“看起来没动”的边界）**
- **以 `poNumber` 为维度**：同一 `poNumber` 即使在领星侧拆单/多行，也只回传 **1 张汇总发票** 给 DSCO（`invoiceId = poNumber`）。
- **必须全量发货才回传**：系统会对比“DSCO 订单期望数量”和“领星实际出库数量”，只有当 `poNumber` 下所有 SKU 均满足“已出库数量 ≥ 期望数量”才会回传发票；否则跳过等待下次。
- **价格口径**：单价优先取 DSCO 原始订单行项目；若关键 SKU 缺少单价导致无法计算总额，会跳过（避免回传不完整发票）。
- **tracking 不在发票接口回传**：DSCO 发票接口不接受顶层 trackingNumber，本系统只在日志中记录 tracking；tracking 由发货回传任务负责。

**R6：多行/多数量订单的可选禁用开关（multi_ban）**
- `ack_to_dsco` / `ship_to_dsco` / `invoice_to_dsco` 支持 `multi_ban`：当开启时，系统会跳过“多 SKU 或单 SKU 多数量”的订单（不推进状态）。
- 该开关用于控制复杂单的风险与排查成本；业务侧如发现某类订单长期不回写，需确认是否启用了该开关。

---

## 5. “什么情况下算异常”与常见原因（业务可理解版）

### 5.1 异常的业务定义（推荐口径）

满足任一情况，可视为异常并反馈技术侧排查：

1) **订单在同一阶段持续多个任务周期不推进**（例如领星已发货，但 DSCO 长时间无 tracking / invoice）。  
2) **同一 `poNumber` 在 DSCO 与领星之间出现长期不一致且不收敛**（状态、运单、发票、库存等）。  
3) **出现“应当被处理”的订单被系统长期跳过**（例如映射已配置齐全、领星状态已满足，但仍不推进）。

> 说明：由于系统不落库“失败原因”，异常的精确原因通常需要结合日志定位。

### 5.2 常见异常原因（按出现概率从高到低）

**A. 配置/映射问题（最常见）**
- `mapping.shop` 缺失：无法确定领星店铺/查询 SID，推单、发货、发票都会受影响。
- `mapping.shipment` 缺失：推单需要的物流方式无法确定。
- `mapping.sku` 缺失或错误：会影响发货/发票/库存回传时的 SKU 对齐；缺失时会按“同名直传”兜底，但可能导致 DSCO 匹配失败。
- `mapping.warehouse` 缺失：库存同步无法进行；推单仓库路由也可能不准确。

**B. 数据前置条件不满足（属于“规则边界”，并非系统故障）**
- 领星侧尚未审核/未出库：ACK/发货/发票自然不会推进。
- 发票回传要求“全量发货”：部分发货或数据未齐会被跳过。
- DSCO 原始订单缺少必要字段（地址/价格等）：推单或发票会被跳过。

**C. 外部系统不可用或限流**
- DSCO/领星接口超时、限流、偶发错误：系统会记录日志并等待下次任务重试。

**D. 任务互斥导致的延迟**
- 同一 job 不并发：当积压大或单次运行耗时长，会导致后续触发被拒绝，从而拉长延迟。

**E. SKU 配对冲突导致自动补丁终止**
- `pull_sku_pair` 发现 MSKU/SKU 一对多、多对一或跨店铺冲突，会终止并不更新 `mapping.sku`（避免写入错误映射），需要先消解冲突。

---

## 6. 业务侧需要提供的信息（用于技术排查）

当你判断“可能异常”时，请提供以下信息（越全越快定位）：

- `poNumber`（必填）
- 你观察到的不一致点：在哪个系统看到什么结果（状态/运单/发票/库存）
- 首次发现时间与期望完成时间（大概即可）
- 若有：领星侧订单号/出库单号、tracking、发票号等

---

## 7. 重要约定（避免误解）

- **时间口径**：系统内部处理与定时调度均使用 UTC；页面展示时区可单独配置，但不影响内部逻辑。  
- **映射方向**：`mapping.*` 统一为 **DSCO → 领星**；如需反向映射（领星 → DSCO），系统在执行时在内存中构建。  
- **失败原因不落库**：系统一期只写日志用于排查；业务侧看到“没推进”并不等于“系统没执行”，需要结合日志确认原因。

