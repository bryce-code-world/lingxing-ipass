# DSCO 同步领星：开发设计（重构版 · 目录与依赖）

本文基于 `doc/DSCO同步领星设计文档/1.业务需求.md`，定义 “目标工程结构（目录/文件）与依赖关系”。

## 0. 架构风格（命名 + 设计取向）

架构命名：**模块化单体（Modular Monolith）+ 任务模块化（Task Modules by Integration Domain）**。

核心观点：
- **任务模块是核心**：无论是定时触发还是 Admin 手动触发，本质都是调用同一组“任务模块”完成工作；触发时机不同，但执行逻辑一致。
- **按集成领域划分任务模块**：例如 `dsco_lingxing` 表示“DSCO ↔ 领星”这一组任务；未来新增 SPS/三方仓等，新增同级模块即可，边界清晰。
- **transport/infra 提到根目录**：避免 `internal/` 外壳造成“所有东西又塞回一个大目录”的感觉；让协议层与基础设施层在工程结构上更直观。

适用前提（已确认）：
- 本仓库是“对领星赋能”的三方集成应用服务，不会作为通用库被其他项目 import 使用。

依赖与基础设施约束：
- DB：PostgreSQL
- ORM：GORM（禁止业务层直接用 `database/sql` 做 CRUD）
- 日志：`golibv2/v2/tool/logger`
- DB 客户端封装：优先复用 `golibv2/v2/tool/db/*`（gorm 集成包）
- SDK：DSCO：`golibv2/v2/sdk/dsco`；领星：`golibv2/v2/sdk/lingxing`
  - `golibv2` 位于 Go 安装目录的 `src` 中，按系统包方式直接 import 使用。

## 1. 配置存放位置（env.yaml + DB 运行时配置）

本项目分两类配置：

1) **基础启动配置（`env.yaml` + 环境变量覆盖）**：只用于把服务启动起来
- 文件：根目录 `env.yaml`
- 内容：监听地址、PostgreSQL DSN、Admin 单密码、日志目录等
- 约定：环境变量可覆盖 `env.yaml`（便于容器化/部署）

2) **运行时配置（DB 持久化 + Admin 热更新）**：业务运行过程中的一切可变配置
- 形态：PostgreSQL 表中存一份“当前生效配置”（通常为 JSON），并配套审计表
- 内容：DSCO/领星连接信息、任务开关/周期/批大小、映射 JSON、Admin 展示时区、导出目录等
- 行为：Admin 保存即生效（热更新）；任务执行读取“当前快照”

运行时配置一致性（已确认）：
- 任务启动时获取一次“配置快照”，本次执行全程使用同一快照。
- 配置更新仅影响下一次任务执行，不影响正在执行中的任务。

## 2. 目标目录结构（精确到文件，注释即职责与依赖）

```text
.
├── main.go
│   └── # 唯一入口：加载 env.yaml（并允许 env 覆盖）
│       # 初始化 logger、PostgreSQL(gormx)、运行时配置管理（从 DB 读当前配置）
│       # 初始化任务模块（integration/*）依赖：store、sdk clients 等
│       # 启动 HTTP（挂载 /admin）与定时触发器（transport/scheduler），优雅退出
│
├── env.yaml
│   └── # 基础启动配置（示例字段：listen_addr、pg_dsn、admin_password、log_dir）
│
├── admin/                         # Admin 资源与代码全部在此目录；对外统一 /admin 前缀
│   ├── assets.go                  # embed templates/static
│   ├── server.go                  # Gin 组装：/admin 路由组 + 中间件 + 模板/静态初始化
│   ├── auth.go                    # 单密码鉴权 + session cookie（密码来自 env.yaml/env）
│   ├── handlers/                  # 所有 handler 统一收口在一个目录，避免散落
│   │   ├── ui.go                  # /admin/ui/*：页面渲染（列表、详情、配置页、任务页、导出页）
│   │   ├── api_config.go          # /admin/api/config/*：读写运行时配置（校验 JSON/字段范围，保存即生效）
│   │   ├── api_jobs.go            # /admin/api/jobs/*：手动触发任务、查询运行记录；任务运行中则拒绝
│   │   ├── api_orders.go          # /admin/api/orders/*：手动拉单入库([start,end), 可选 status=1~5)、订单查询
│   │   ├── api_stocks.go          # /admin/api/stocks/*：库存同步日志查询
│   │   └── api_export.go          # /admin/api/export/*：导出 CSV（最大 1 年；生成文件并立即下载；超时设置更大）
│   ├── static/
│   │   ├── admin.css
│   │   └── admin.js
│   └── templates/
│       ├── layout.html
│       ├── login.html
│       ├── dashboard.html
│       ├── config.html
│       ├── jobs.html
│       ├── orders.html
│       ├── order_detail.html
│       ├── warehouse_sync.html
│       └── error.html
│
├── transport/                     # 协议层：触发机制（HTTP/定时），不承载业务规则
│   ├── httpserver/
│   │   └── server.go              # http.Server 启动与优雅退出（read/write timeout 等）
│   └── scheduler/
│       └── scheduler.go           # 定时触发器：按“运行时配置”调度任务；同一任务不并发触发
│
├── integration/                   # 任务模块：按集成领域划分（可扩展：dsco_lingxing / sps_lingxing / 3pl_lingxing / ...）
│   ├── registry.go                # 任务注册表：列出系统支持的所有任务（供 scheduler/admin 共用）
│   ├── runner.go                  # 统一执行入口：读取运行时配置快照 -> 加锁 -> 记运行记录 -> 调用具体任务函数（只做样板，不写业务规则）
│   ├── types.go                   # 统一类型：JobName、RunResult、错误分类、任务参数公共结构等
│   ├── dsco_lingxing/              # 当前一期：DSCO ↔ 领星
│   │   ├── order/
│   │   │   ├── types.go           # 本模块订单任务共享类型（如手动拉单参数、统计结果）
│   │   │   ├── pull_dsco_orders.go # 拉单：DSCO created_at，[start,end)，空表从 2025-01-01T00:00:00Z
│   │   │   ├── push_to_lingxing.go # 推单：platform_order_no=po_number；状态 1->2；幂等
│   │   │   ├── ack_to_dsco.go      # ACK：领星 status=5/6；状态 2->3；幂等
│   │   │   ├── ship_to_dsco.go     # 发货：tracking_no/global_delivery_time/logistics_type_name 映射到 DSCO；状态 3->4
│   │   │   └── invoice_to_dsco.go  # 发票：DSCO 原始订单字段 + 查领星出库确定实发数量/总金额；状态 4->5；幂等
│   │   └── inventory/
│   │       └── sync_inventory.go       # 库存：对账更新 DSCO，写 dsco_warehouse_sync；批大小按配置；不并发
│   ├── ops/
│   │   └── cleanup_exports.go      # 运维任务：清理导出目录（总大小 > 100MB 时清理；按“最旧优先”删）
│   └── _template/
│       └── README.md              # 新增集成模块时的目录模板与约定（任务命名/依赖注入/落库规则）
│
├── infra/                          # 基础设施层：DB/配置存储/DAO/外部 client（GORM/SDK 封装）
│   ├── config/
│   │   ├── envyaml.go             # 读取 env.yaml（并支持 env 覆盖）
│   │   ├── runtime_types.go       # 运行时配置结构（DB 持久化的那份）
│   │   ├── runtime_validate.go    # 运行时配置校验（失败不得生效）
│   │   └── runtime_manager.go     # 运行时配置管理（从 DB 读；Admin 更新后原子替换）
│   ├── db/
│   │   ├── postgres.go            # PostgreSQL 初始化：优先复用 golibv2/v2/tool/db 下的 gormx client
│   │   └── tx.go                  # 事务小工具（可选）
│   └── store/
│       ├── runtime_config_store.go      # 运行时配置持久化（当前生效配置）
│       ├── dsco_order_sync_store.go     # dsco_order_sync：upsert(po_number 唯一)、查询/导出
│       └── dsco_warehouse_sync_store.go # dsco_warehouse_sync：写日志、查询/导出
│
├── exports/                        # 导出文件落地目录（部署机器本地磁盘）
│   └── # 路径由“运行时配置”注入；导出生成 CSV 文件后写入该目录并立即下载
│       # 清理策略：由 integration/ops/cleanup_exports.go 定时检查；目录总大小超过 100MB 时触发清理
│
├── migrations/
│   ├── init.sql                    # PostgreSQL 初始化建表（禁止运行时 AutoMigrate）
│   └── README.md                   # 迁移执行说明（部署脚本/DBA 执行）
│
├── docker/
│   └── docker-compose.yml          # 本地开发 PostgreSQL（可选）
│
└── doc/DSCO同步领星设计文档/
    ├── 业务需求.md
    └── 开发设计.md
```

## 3. 依赖关系（强约束）

```text
main.go
  -> infra/*                 # DB/配置/DAO/锁/运行记录（基础设施）
  -> integration/*           # 任务模块（按集成领域划分）
  -> transport/*             # 触发器（HTTP server / scheduler）
  -> admin/*                 # /admin UI + API（通过 integration/runner 触发任务，通过 infra/store 查询/导出）
```

规则：
- `transport/*` 只能“触发”，不得写业务规则；触发时统一调用 `integration/runner.go`。
- `admin/*` 与 `transport/scheduler/*` 都是触发端：两者调用同一套任务注册表与 runner。
- `integration/*` 是业务“任务模块”本体：每个任务是一个独立职责边界。
- 任务调用约束（已确认写死）：
  - 任务 **只允许** 被 `integration/runner.go` 调用。
  - 任务之间 **禁止互调/互相编排**。
  - 协议层（`transport/*`、`admin/*`）只能触发 runner，不得绕过 runner 直接调用任务。
- `infra/*` 只做基础设施：DB、配置、DAO、互斥锁、运行记录；不写 DSCO/领星业务规则。
- 代码可见性约束（已确认）：虽然无 `internal/` 外壳，但尽量减少不必要的导出符号（exported identifiers），避免出现“到处直接 import infra/store 并拼业务逻辑”的坏味道。

## 4. 约束清单（写死，避免跑偏）

### 5.1 runner 的职责边界（已确认）

- `integration/runner.go` 只做“编排与通用样板”：
  - 获取运行时配置快照
  - 加锁（同一任务不并发，定时/手动共享）
  - 记录运行记录（开始/结束/耗时/错误）
  - 调用具体任务函数
- `integration/runner.go` 不得承载具体业务规则（字段映射、状态推进、DSCO/领星接口细节等）。

### 5.2 模型与复用（已确认取向）

- 各端模型与接口定义来自 `golibv2` 中的 SDK（DSCO/领星/未来其他端）。
- 任务模块内不再定义需要跨模块复用的“业务模型”，模块之间不做模型复用。

### 5.3 导出文件落地与清理（已确认）

- CSV 导出文件落地在部署机器磁盘，目录路径由运行时配置注入。
- Admin 提供导出时“生成文件并立即下载”的能力。
- 清理任务：当导出目录总大小超过 100MB 时触发清理（按最旧优先删除）。

## 5. 这样设计的收益与扩展性

- 目录即架构：`transport/`（触发）+ `integration/`（任务模块）+ `infra/`（基础设施）一眼能看懂边界。
- 触发复用：定时与 Admin 触发共享 `integration/registry.go` + `integration/runner.go`，避免两套实现跑偏。
- 集成扩展：新增集成只需在 `integration/` 下增加新模块目录（如 `sps_lingxing/`），并在 `integration/registry.go` 注册任务。
- 任务颗粒度清晰：每个 `.go` 文件就是一个具体任务（拉单/推单/ACK/发货/发票/库存），便于替换与演进。
- 配置位置清晰：启动配置在根目录 `env.yaml`；运行时配置在 DB 且可热更新并审计。
