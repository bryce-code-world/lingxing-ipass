# 第八章 Admin 后台定义（页面 + API）

本文基于当前实现与 `doc/DSCO同步领星设计文档/1.业务需求.md`，定义 Admin 后台的页面与 API 口径。

约束（已确认）：
- 单密码鉴权（密码来自 `env.yaml admin.password`）。
- 不做任务运行记录表/配置审计表；需要排查细节时以日志为准。
- 服务内部时间统一 UTC；Admin 展示时区由 `env.yaml admin.display_timezone` 控制（仅展示/输入解释，不影响存储）。

## 1. 页面清单（Apple 风格，简洁优先）

导航：
- `Dashboard`：概览
- `Config`：运行时配置（runtime_config）
- `Tasks`：手动触发任务/手动拉单
- `Orders`：`dsco_order_sync` 列表 + 详情 + 编辑状态 + 导出
- `Warehouses`：`dsco_warehouse_sync` 列表 + 导出
- `Logout`

## 2. Dashboard

路径：`GET /admin/`

展示：
- 运行时配置 domain（默认 `dsco_lingxing`）与更新时间
- 订单状态统计：按 `status=1..6` 分桶统计
- 快捷入口：跳转到 Tasks / Orders / Config

## 3. Config（运行时配置）

路径：`GET /admin/config`

功能：
- `GET /admin/api/config/runtime?domain=dsco_lingxing`：加载配置
- `PUT /admin/api/config/runtime?domain=dsco_lingxing`：保存配置（保存即生效）

说明：
- runtime_config 仅存储可热更新的配置（jobs + mapping），敏感授权信息（DSCO token、领星 app_id/app_secret）仅在 `env.yaml` 配置，不在页面中展示或编辑。

## 4. Tasks（手动触发）

路径：`GET /admin/tasks`

功能：
1) 一键触发所有任务（按默认顺序）：`POST /admin/api/jobs/run`（body 允许为空）
2) 手动触发单个任务：`POST /admin/api/jobs/run_one`（body：`{ "job": "pull_dsco_orders" }`）
3) 手动拉取 DSCO 订单入库：`POST /admin/api/dsco_order_sync/pull`

手动拉单入参（UTC 秒级时间戳；范围边界 `[start,end)`）：
```json
{ "start": 1700000000, "end": 1700086400 }
```

说明（已确认）：
- 手动拉单入库不再支持传入/选择入库 `status`；入库 `status` 由 DSCO 的 `dsco_status` 自动推导。
- 手动触发任务不受 `jobs.<job>.enable`（定时开关）限制；`enable` 仅控制 scheduler 是否自动触发。
- 同一任务不允许并发（运行中返回 409）。

## 5. Orders（dsco_order_sync）

### 5.1 列表

路径：`GET /admin/orders`

API：
- 查询：`GET /admin/api/dsco_order_sync/list`
- 导出：`POST /admin/api/export/dsco_order_sync`（生成 CSV 并立即下载）
- 单订单执行：`POST /admin/api/dsco_order_sync/run_one`

查询入参（QueryString，分页 + 筛选）：
- `offset`：默认 `0`
- `limit`：默认 `50`
- `po_number`：模糊匹配（包含）
- `dsco_retailer_id`：精确匹配
- `msku`：按 `mskus` 匹配（兼容 `sku` / `sku(quantity)`）
- `warehouse_id`：精确匹配
- `shipment`：精确匹配
- `tracking`：包含匹配（用于筛选多运单号；本地存储为英文逗号拼接）
- `invoice_id`：包含匹配
- `dsco_status`：精确匹配
- `status`：多选（逗号分隔，例如 `1,2,3`）
- `start`/`end`：`dsco_create_time` 的 `[start,end)`（UTC 秒）

说明：
- 默认按 `dsco_create_time DESC` 排序。
- `limit` 支持在页面上选择（例如 20/50/100）。
- 时间过滤边界为 `[start,end)`。

列表展示字段（与实现一致）：
- `id`
- `po_number`
- `dsco_create_time`（按 `admin.display_timezone` 格式化显示）
- `dsco_status`
- `status`
- `warehouse_id`
- `shipment`
- `dsco_retailer_id`
- `mskus`（展示为逗号分隔；元素格式为 `sku(quantity)`，保留重复行）
- `shipped_tracking_no`
- `dsco_invoice_id`
- actions：`View`（查看详情）、`Run`（仅对单个订单执行任务）、`Edit`（编辑 status）

单订单执行（Run）口径（写死）：

- 仅对 `status=1..4` 可执行；`status=5/6`（已完成/取消）按钮禁用。
- 任务选择规则（按当前 status 自动映射）：
  - `1` → `push_to_lingxing`
  - `2` → `ack_to_dsco`
  - `3` → `ship_to_dsco`
  - `4` → `invoice_to_dsco`
- 仅处理该 `po_number`，不影响其他订单。
- “条件不满足”视为执行成功：接口返回 OK，并通过 `status_before/status_after/status_changed` 提示本次是否推进状态（未推进通常表示外部数据未就绪，稍后再试）。

API：
- `POST /admin/api/dsco_order_sync/run_one`
  - body：`{ "po_number": "C2S5..." }`
  - 返回：`job/status_before/status_after/status_changed`

### 5.2 查看详情

交互：
- 列表行点击 `View` 打开 Modal，展示订单详情 JSON，并提供 Copy 按钮复制到剪贴板。

API：
- `GET /admin/api/dsco_order_sync/detail?id=<id>`

返回（snake_case）：
- 基本字段（同列表）
- `payload`：原始 DSCO 订单 JSON（用于排查）

### 5.3 编辑同步状态（status）

交互：
- 列表行点击 `Edit` 打开 Modal，输入新的 `status`（范围 1..6）并提交。

API：
- `PUT /admin/api/dsco_order_sync/status`
  - body：`{ "po_number": "C2S5...", "status": 3 }`

说明：
- 该操作用于人工干预重跑/跳阶段；属于强操作，一期不做审计表，仅在日志中记录变更。
  - 常见用法：将 `status=3` 的订单人工改回 `2` 以便重新 ACK；或将 `status=4` 改为 `3` 以便重新回传物流；或将 `status=5` 改为 `4` 以便补回传发票。

## 6. Warehouses（dsco_warehouse_sync）

路径：`GET /admin/warehouses`

API：
- 查询：`GET /admin/api/dsco_warehouse_sync/list`
- 条件选项：`GET /admin/api/dsco_warehouse_sync/options`（用于动态下拉：dsco_warehouse_id / lingxing_warehouse_id）
- 导出：`POST /admin/api/export/dsco_warehouse_sync`

查询入参（QueryString，分页 + 筛选）：
- `offset`：默认 `0`
- `limit`：默认 `50`
- `dsco_warehouse_id`
- `dsco_warehouse_sku`
- `lingxing_warehouse_id`
- `lingxing_warehouse_sku`
- `diff_range`：diff 区间筛选（可选值：`lt_-5`、`neg_5_1`、`eq_0`、`pos_1_5`、`gt_5`）
- `status`：多选（逗号分隔，例如 `1,2`）
- `start`/`end`：`sync_time` 的 `[start,end)`（UTC 秒）

说明：
- 默认按 `sync_time DESC` 排序。
- `reason` 字段保留但一期默认不写入（仅日志）。

## 7. CSV 导出与清理

导出策略（已确认）：
- 导出为同步生成文件并立即下载（同步响应）。
- 最大时间范围：允许导出跨度 1 年（服务端设置更大的超时）。
- 导出文件落地目录：`env.yaml admin.export_dir`。
- 清理任务：定时清理导出目录，当总大小超过 100MB 时按“最旧优先”删除。
