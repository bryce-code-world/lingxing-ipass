# 第八章 Admin 后台：页面与功能设计（Apple 风格）

本文基于：

- `doc/DSCO同步领星设计文档/1.业务需求.md`
- `doc/DSCO同步领星设计文档/2.架构设计.md`
- `doc/DSCO同步领星设计文档/3.数据库设计.md`
- `doc/DSCO同步领星设计文档/4.配置设计.md`
- `doc/DSCO同步领星设计文档/5.infra基础设施层开发设计.md`
- `doc/DSCO同步领星设计文档/6.transport协议层设计.md`
- `doc/DSCO同步领星设计文档/7.integration层dsco同步领星任务定义.md`

目标：定义 Admin 后台的页面信息架构、关键交互、以及 `/admin` 前缀下的 API（后端）口径，便于直接落地实现。

---

## 1. Admin 定位与边界（写死）

- Admin 是本服务的“控制台”：**配置管理 + 手动触发任务 + 数据查询/导出**。
- Admin 无多用户/无权限系统：**单密码登录**（密码来自 `env.yaml admin.password` 或环境变量覆盖）。
- Admin 与业务任务共享同一进程：HTTP（Gin）对外服务统一挂载在 `/admin` 前缀下（见 transport 设计）。
- 任务执行结果不落库：需要看任务执行细节时以日志为准（按已确认：不建 `job_run` 表）。

---

## 2. 设计风格（Apple 取向）

视觉与交互原则（用于落地 UI，非强制实现但要求方向一致）：

- 极简布局：单列内容区 + 清晰留白；减少花哨组件。
- 强一致性：统一的按钮样式/间距/标题层级/表格密度。
- 信息分层：重要信息前置；高级选项折叠。
- 交互可预期：
  - 所有危险操作（保存配置、手动拉单、手动触发任务）都要二次确认。
  - 所有操作都要有明确反馈（成功/失败/拒绝原因）。
- 文本与表格可读性优先：默认使用系统字体栈，表格支持列宽自适应、关键字段可复制。

---

## 3. 路由约定（写死）

统一前缀：

- UI 页面：`/admin`（返回 HTML）
- API：`/admin/api/*`（返回 JSON）
- 静态资源：`/admin/static/*`（CSS/JS）

建议路由组织：

- 页面（HTML）：`GET /admin/login`、`GET /admin/dashboard`、`GET /admin/config`、`GET /admin/tasks`、`GET /admin/orders`、`GET /admin/warehouses`
- API（JSON）：`/admin/api/auth/*`、`/admin/api/config/*`、`/admin/api/jobs/*`、`/admin/api/dsco_order_sync/*`、`/admin/api/dsco_warehouse_sync/*`、`/admin/api/export/*`

---

## 4. 页面信息架构（IA）

建议左侧导航（或顶部 Tab，取决于实现）：

1) Dashboard（概览）
2) 配置（运行时配置）
3) 任务（手动触发/全量触发）
4) 订单同步（dsco_order_sync）
5) 库存同步（dsco_warehouse_sync）

页面公共组件：

- 顶部栏：当前环境（`base.env`）、当前域（固定 `dsco_lingxing`）、运行时配置更新时间（`runtime_config.updated_at`，UTC 秒）与“刷新”按钮。
- 时间展示：所有 DB 时间戳按 `env.yaml admin.display_timezone` 转换展示（仅展示，不影响内部 UTC）。
- 复制体验：`po_number`、`dsco_order_id`、`platform_order_no` 等字段一键复制。

---

## 5. 页面与功能设计

### 5.1 Login（登录）

路径：`GET /admin/login`

功能：

- 输入单密码（来自 `admin.password`）。
- 成功后写 session cookie（HttpOnly；SameSite=Lax；建议 Secure 由部署决定）。
- 登录失败给出统一提示（避免泄露细节）。

API：

- `POST /admin/api/auth/login`
- `POST /admin/api/auth/logout`
- `GET /admin/api/auth/me`（用于前端判断登录态）

### 5.2 Dashboard（概览）

路径：`GET /admin/dashboard`

展示内容（最小可用）：

- 当前环境：`base.env`
- 当前展示时区：`admin.display_timezone`
- 运行时配置：
  - domain：固定 `dsco_lingxing`
  - `runtime_config.updated_at`
  - jobs 启用情况摘要（启用/禁用数量）
- 数据概览（从 DB 聚合）：
  - `dsco_order_sync`：按 status=1..5 的数量
  - `dsco_warehouse_sync`：最近 N 天记录数（N 可固定为 1/7/30，或不做）
- 快捷操作：
  - 跳转到“配置”
  - 跳转到“任务”

> 说明：不展示“任务运行记录/最后一次执行结果”，因为不落库；需要排查看日志。

### 5.3 配置（运行时配置 runtime_config）

路径：`GET /admin/config`

目标：可在后台直接修改服务配置（已确认“保存即生效”）。

可编辑范围（写死）：

- 仅编辑 `runtime_config.config`（JSON），domain 固定 `dsco_lingxing`。
- `env.yaml` 的 `auth/*` 与 `integration/*` 不在 Admin 编辑（部署级固定配置）。

交互设计：

- Apple 风格推荐：表单化编辑（jobs/mapping 分组）+ 右侧“高级：JSON 编辑器”折叠区（二选一或同时提供）。
- 保存前校验：
  - JSON 合法 + 业务校验（见第四章：cron/size/job 白名单、mapping 方向 DSCO→领星、反向映射冲突等）
- 保存确认：弹窗显示“保存即生效，仅影响下一次任务执行”。
- 保存成功：提示并刷新 `updated_at`。

页面分组（建议）：

1) Jobs（任务调度）
   - 每个 job：`enable`、`cron`、`size`
2) Mapping（业务映射，DSCO → 领星）
   - `shop`：DSCO 渠道/店铺标识 → 领星 store_id
   - `warehouse`：DSCO warehouseCode → 领星 WID
   - `sku`：DSCO partnerSku → 领星 MSKU（或 SKU）
   - `shipment`：DSCO shipMethod → 领星 logistics_type_name

API：

- `GET /admin/api/config/runtime?domain=dsco_lingxing`
- `PUT /admin/api/config/runtime?domain=dsco_lingxing`
  - 保存时执行校验；失败不得生效。

### 5.4 任务（手动触发）

路径：`GET /admin/tasks`

功能（已确认）：

1) 手动触发所有任务执行（一次性触发全量）
2) 手动触发单个任务

交互设计：

- 页面展示任务列表（与 `runtime_config.jobs` 对齐）：
  - job 名称、是否启用、cron、size
  - 操作按钮：`Run once`（手动执行一次）
- “Run all” 按钮：依次触发所有支持的任务（按固定顺序；例如按状态机顺序：pull→push→ack→ship→invoice→stock）
- 并发互斥提示：
  - 若任务正在执行：按钮置灰并提示“任务运行中，稍后再试”

API：

- `POST /admin/api/jobs/run`
  - body：`{ "jobs": ["pull_dsco_orders", ...] }`；为空表示按默认顺序触发全部
- `POST /admin/api/jobs/run_one`
  - body：`{ "job": "pull_dsco_orders" }`

返回：

- 仅返回“已接受/被拒绝（运行中）/配置不满足”等结果；具体执行细节在日志中。

### 5.5 订单同步（dsco_order_sync 列表/详情/手动拉单/导出）

路径：

- 列表：`GET /admin/orders`
- 详情：`GET /admin/orders/:id`（或 `?id=`）

列表功能（已确认）：

- 可根据多个字段条件查询 dsco_order_sync 数据列表
- 可根据条件导出 CSV

建议过滤条件（一期最小集，后续可扩展）：

- 时间范围（UTC 存储，按 display_timezone 展示）：
  - `dsco_create_time` `[start,end)`（支持最大 1 年，受 `admin.export.max_range_days` 限制）
- `status`：1~5（多选）
- `po_number`（精确/模糊）
- `dsco_order_id`（精确）
- `consumer_order_number`（精确/模糊）
- `channel`（精确）
- `msku`（精确；若表设计为数组，可做包含查询）

列表列字段（建议）：

- `id`
- `po_number`
- `dsco_order_id`
- `consumer_order_number`
- `channel`
- `dsco_create_time`（展示为本地时区格式）
- `status`
- `updated_at`
- 操作：查看详情

详情页（建议）：

- 基本字段（同上）
- payload 展示（JSON，支持折叠与复制；注意大字段性能）
- Admin 操作区：
  - “复制 po_number”
  - “根据该订单触发任务（可选）”：严格仍走 runner，且遵守互斥

手动拉单入库（已确认）：

- 在列表页提供“手动拉单”按钮，打开 Drawer/Modal：
  - `start` / `end`（UTC，边界 `[start,end)`）
  - `status`（1~5，可直接置为 5，用于初始化补数据；也允许置为 1 用于紧急同步）
- 行为：
  - 拉取 DSCO 订单基于 `created_at`
  - 已存在订单：覆盖 `payload` + 覆盖 `status`

API：

- 查询：
  - `GET /admin/api/dsco_order_sync/list`（支持分页）
  - `GET /admin/api/dsco_order_sync/detail?id=...`
- 手动拉单：
  - `POST /admin/api/dsco_order_sync/pull`
    - body：`{ "start": 1700000000, "end": 1700086400, "status": 1 }`（UTC 秒）
- 导出：
  - `POST /admin/api/export/dsco_order_sync`
    - body：同 list 的过滤条件（服务端生成 CSV 文件并立即下载）

### 5.6 库存同步（dsco_warehouse_sync 列表/导出）

路径：`GET /admin/warehouses`

功能（已确认）：

- 可根据多个字段条件查询 dsco_warehouse_sync 数据列表
- 可根据条件导出 CSV

建议过滤条件（一期最小集）：

- 时间范围（`created_at` 或记录时间字段，UTC 秒）：`[start,end)`（最大 1 年）
- `warehouse_code`（DSCO）
- `wid`（领星）
- `sku`（领星） / `partner_sku`（DSCO，若落库）
- `result`（成功/失败，如果表中有结果字段；否则不提供）

列表列字段（建议）：

- `id`
- `created_at`
- `warehouse_code` / `wid`
- `sku` / `partner_sku`
- `qty`（同步的可用量）
- 备注/错误（若不落库错误则不显示）

API：

- `GET /admin/api/dsco_warehouse_sync/list`
- `POST /admin/api/export/dsco_warehouse_sync`

---

## 6. CSV 导出与下载（后端口径）

已确认业务规则：

- 导出范围最大 1 年（`admin.export.max_range_days=365`）
- 生成 CSV 文件并立即下载（接口 timeout 需要放大）
- 文件落地目录：`admin.export.dir`
- 清理：由后台清理任务在目录总大小 > `admin.export.cleanup_threshold_bytes`（100MB）时清理

后端实现口径（写死）：

- 导出 API 返回 `Content-Disposition: attachment; filename=...`，直接返回文件流（或 gin.File）
- 文件命名携带实体名 + 时间（不包含敏感字段）
- 写文件使用“临时文件 + rename”避免半文件（见 infra/export 设计）

---

## 7. API 规范（统一口径）

### 7.1 统一响应结构（建议）

所有 `/admin/api/*` 返回统一 envelope：

```json
{ "code": 0, "message": "ok", "data": {} }
```

- `code=0` 表示成功
- 非 0 表示错误（包含校验失败、运行中拒绝、外部依赖缺失等）

### 7.2 分页结构（建议）

list API 返回：

```json
{ "code": 0, "message": "ok", "data": { "items": [], "total": 0 } }
```

### 7.3 运行中互斥的错误码（建议）

- 当任务互斥锁未获取：返回 `code=409`（或 `code=1001`）并提示“任务运行中”

---

## 8. 与配置/任务定义的一致性检查点

实现前必须自检（避免跑偏）：

- Admin 只编辑 `runtime_config`，不编辑 `env.yaml` 的 `auth/*` 与 `integration/*`
- 任务调度字段以 `runtime_config.jobs.<job>.{enable,cron,size}` 为准（cron 为 6 段秒级，UTC）
- `mapping` 方向为 **DSCO → 领星**；需要反向映射的任务（shipment/stock 等）在内存构建反向 map
- 时间存储与传输：DB 为 UTC 秒级 `bigint`；API 传入/传出时间戳；UI 按 `admin.display_timezone` 展示
