# 第三章 数据库设计（PostgreSQL）

本文基于 `doc/DSCO同步领星设计文档/1.业务需求.md` 与当前实现，给出一期 PostgreSQL 的数据表设计。

约束：
- 时间类字段统一保存 UTC 秒级时间戳（`int64`），PostgreSQL 类型为 `bigint`。
- 一期不引入迁移工具；仓库仅保留 `migrations/init.sql` 作为最新建表脚本。
- `id` 字段不加注释，其余字段都加注释（项目约定）。

## 1. 表清单

| 表名 | 用途 |
| --- | --- |
| `runtime_config` | 运行时配置（Admin 修改，保存即生效；任务执行按“配置快照”读取） |
| `dsco_order_sync` | DSCO 订单同步状态表（状态机 1~6 + 原始 payload；允许覆盖更新） |
| `dsco_warehouse_sync` | 库存同步日志（领星库存 → DSCO 库存回写的记录，用于查询与导出） |

## 2. `runtime_config`（运行时配置）

说明：
- 本表用于存储“可热更新”的运行时配置（例如 jobs、mapping 等）。
- 不做配置变更审计表；变更日志仅记录在日志中（一期口径）。

DDL（与 `migrations/init.sql` 保持一致）：

```sql
CREATE TABLE IF NOT EXISTS runtime_config (
  id         bigserial PRIMARY KEY,
  domain     text   NOT NULL,
  config     jsonb  NOT NULL,
  updated_at bigint NOT NULL DEFAULT (EXTRACT(EPOCH FROM now())::bigint),

  CONSTRAINT uk_runtime_config_domain UNIQUE (domain)
);

COMMENT ON TABLE runtime_config IS '运行时配置（Admin 修改后保存即生效；任务执行按“配置快照”读取）';
COMMENT ON COLUMN runtime_config.domain IS '业务领域标识（例如 dsco_lingxing）；同一 domain 仅保留 1 份当前配置';
COMMENT ON COLUMN runtime_config.config IS '运行时配置 JSON（domain/jobs/mapping 等；见配置设计文档）';
COMMENT ON COLUMN runtime_config.updated_at IS '配置更新时间（UTC 秒级时间戳）';
```

## 3. `dsco_order_sync`（订单同步状态表）

### 3.1 状态机（`status`）

- `1`：待推单到领星
- `2`：待 ACK 回传
- `3`：待回传物流（shipment）
- `4`：待回传发票（invoice）
- `5`：完成（已回传发票；或拉单时 `dsco_status=shipped` 直接完成）
- `6`：已取消（`dsco_status=cancelled`）

说明：
- 拉单入库采用 upsert 覆盖更新 `payload` 与派生字段；入库 `status` 由 DSCO `dsco_status` 推导。
- 如需人工调整同步阶段，通过 Admin 订单列表“编辑 status”实现。

### 3.2 关键字段口径

- `po_number`：唯一键（同时也是领星 `platform_order_no`）
- `dsco_create_time`：DSCO `created_at`（仅使用 `dscoCreateDate`；UTC 秒级时间戳）
- `dsco_status`：DSCO 订单拉取时状态（用于推导 `status` 与筛选/导出）
- `dsco_retailer_id`：DSCO `dscoRetailerId`（用于 mapping.shop 与筛选）
- `payload`：DSCO 原始订单 JSON（覆盖更新）
- `mskus`：订单 SKU 列表（从 DSCO 行项目逐行写入，格式为 `sku(quantity)`，保留重复行；用于筛选/导出；`text[]` + GIN 索引）
- `warehouse_id`、`shipment`：DSCO 仓库编码与物流方式编码（用于筛选/导出）
- `shipped_tracking_no`：已回传的物流运单号（可能多个；用英文逗号拼接；用于幂等与筛选/导出）
- `dsco_invoice_id`：已回传发票 ID（一期口径为 `invoiceId=poNumber`；用于幂等与筛选/导出）

### 3.3 DDL

```sql
CREATE TABLE IF NOT EXISTS dsco_order_sync (
  id                    bigserial PRIMARY KEY,

  po_number             text     NOT NULL,

  dsco_create_time      bigint   NOT NULL,
  dsco_status           text     NOT NULL DEFAULT '',
  status                smallint NOT NULL,

  payload               jsonb    NOT NULL,
  mskus                 text[]   NOT NULL DEFAULT '{}'::text[],
  warehouse_id          text     NOT NULL DEFAULT '',
  shipment              text     NOT NULL DEFAULT '',
  dsco_retailer_id      text     NOT NULL DEFAULT '',

  shipped_tracking_no   text     NOT NULL DEFAULT '',
  dsco_invoice_id       text     NOT NULL DEFAULT '',

  created_at            bigint   NOT NULL DEFAULT (EXTRACT(EPOCH FROM now())::bigint),
  updated_at            bigint   NOT NULL DEFAULT (EXTRACT(EPOCH FROM now())::bigint),

  CONSTRAINT uk_dsco_order_sync_po_number UNIQUE (po_number),
  CONSTRAINT ck_dsco_order_sync_status CHECK (status BETWEEN 1 AND 6)
);

CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_create_time
  ON dsco_order_sync (dsco_create_time DESC);

CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_status_create_time
  ON dsco_order_sync (status, dsco_create_time DESC);

CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_warehouse_id
  ON dsco_order_sync (warehouse_id);

CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_shipped_tracking_no
  ON dsco_order_sync (shipped_tracking_no);

CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_dsco_invoice_id
  ON dsco_order_sync (dsco_invoice_id);

-- 支持按 SKU 筛选（兼容 sku / sku(quantity)）：
-- WHERE EXISTS (SELECT 1 FROM unnest(mskus) AS m WHERE m = 'sku123' OR m ILIKE 'sku123(%')
CREATE INDEX IF NOT EXISTS idx_dsco_order_sync_mskus_gin
  ON dsco_order_sync USING GIN (mskus);

COMMENT ON TABLE dsco_order_sync IS 'DSCO 订单同步状态表（状态机 1~6 + 原始 payload；允许覆盖更新）';
COMMENT ON COLUMN dsco_order_sync.po_number IS 'DSCO 订单唯一键（po_number；同时也是领星 platform_order_no）';
COMMENT ON COLUMN dsco_order_sync.dsco_retailer_id IS '订单关联的 DSCO 销售渠道 ID（dscoRetailerId；用于 mapping.shop 与筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.dsco_status IS 'DSCO 订单拉取时状态（例如 created、shipment_pending、shipped、completed）';
COMMENT ON COLUMN dsco_order_sync.dsco_create_time IS 'DSCO 订单 created_at（UTC 秒级时间戳；用于增量拉单与筛选）';
COMMENT ON COLUMN dsco_order_sync.status IS '同步状态：1待推单到领星 2待ACK回传 3待回传物流(shipment) 4待回传发票(invoice) 5完成(已回传发票；或拉单时 dsco_status=shipped 直接完成) 6已取消';
COMMENT ON COLUMN dsco_order_sync.payload IS 'DSCO 原始订单 JSON（覆盖更新）';
COMMENT ON COLUMN dsco_order_sync.mskus IS '订单 SKU 列表（sku(quantity)，保留重复行；用于筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.warehouse_id IS 'DSCO 仓库编码（warehouseCode；用于 mapping.warehouse 与筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.shipment IS 'DSCO 物流方式编码（shipMethod；用于 mapping.shipment 与筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.shipped_tracking_no IS '已回传的物流运单号（trackingNumber；用于筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.dsco_invoice_id IS '已回传的发票 ID（invoiceId；用于筛选/导出）';
COMMENT ON COLUMN dsco_order_sync.created_at IS '创建时间（UTC 秒级时间戳）';
COMMENT ON COLUMN dsco_order_sync.updated_at IS '更新时间（UTC 秒级时间戳）';
```

## 4. `dsco_warehouse_sync`（库存同步日志）

说明：
- 本表用于记录“领星库存 → DSCO 库存回写”的结果，支撑 Admin 查询与导出。
- `reason` 字段保留但一期默认不写入（仅日志）。

DDL（与 `migrations/init.sql` 保持一致）：

```sql
CREATE TABLE IF NOT EXISTS dsco_warehouse_sync (
  id                     bigserial PRIMARY KEY,

  sync_time              bigint   NOT NULL,

  dsco_warehouse_id      text     NOT NULL DEFAULT '',
  dsco_warehouse_sku     text     NOT NULL DEFAULT '',
  dsco_warehouse_num     integer  NOT NULL DEFAULT 0,

  lingxing_warehouse_id  text     NOT NULL DEFAULT '',
  lingxing_warehouse_sku text     NOT NULL DEFAULT '',
  lingxing_warehouse_num integer  NOT NULL DEFAULT 0,
  diff                  integer  NOT NULL DEFAULT 0,

  status                 smallint NOT NULL,
  reason                 text     NOT NULL DEFAULT '',

  created_at             bigint   NOT NULL DEFAULT (EXTRACT(EPOCH FROM now())::bigint),
  updated_at             bigint   NOT NULL DEFAULT (EXTRACT(EPOCH FROM now())::bigint),

  CONSTRAINT ck_dsco_warehouse_sync_status CHECK (status IN (1,2))
);

CREATE INDEX IF NOT EXISTS idx_dsco_warehouse_sync_time
  ON dsco_warehouse_sync (sync_time DESC);

CREATE INDEX IF NOT EXISTS idx_dsco_warehouse_sync_dsco_wh_sku_time
  ON dsco_warehouse_sync (dsco_warehouse_id, dsco_warehouse_sku, sync_time DESC);

CREATE INDEX IF NOT EXISTS idx_dsco_warehouse_sync_status_time
  ON dsco_warehouse_sync (status, sync_time DESC);

CREATE INDEX IF NOT EXISTS idx_dsco_warehouse_sync_diff_time
  ON dsco_warehouse_sync (diff, sync_time DESC);

COMMENT ON TABLE dsco_warehouse_sync IS '库存同步日志（领星库存 → DSCO 库存回写的记录，用于查询与导出）';
COMMENT ON COLUMN dsco_warehouse_sync.sync_time IS '同步时间（UTC 秒级时间戳）';
COMMENT ON COLUMN dsco_warehouse_sync.dsco_warehouse_id IS 'DSCO 仓库编码（warehouseCode）';
COMMENT ON COLUMN dsco_warehouse_sync.dsco_warehouse_sku IS 'DSCO SKU（partnerSku 或 sku；用于 DSCO 入参）';
COMMENT ON COLUMN dsco_warehouse_sync.dsco_warehouse_num IS 'DSCO 数量（同步前读取的 DSCO 仓库库存数量）';
COMMENT ON COLUMN dsco_warehouse_sync.lingxing_warehouse_id IS '领星仓库 WID';
COMMENT ON COLUMN dsco_warehouse_sync.lingxing_warehouse_sku IS '领星 SKU';
COMMENT ON COLUMN dsco_warehouse_sync.lingxing_warehouse_num IS '领星数量（可用库存）';
COMMENT ON COLUMN dsco_warehouse_sync.diff IS '库存差值（领星 - DSCO）';
COMMENT ON COLUMN dsco_warehouse_sync.status IS '同步状态：1成功 2失败';
COMMENT ON COLUMN dsco_warehouse_sync.reason IS '失败原因（一期默认不写入，仅保留字段扩展位）';
COMMENT ON COLUMN dsco_warehouse_sync.created_at IS '创建时间（UTC 秒级时间戳）';
COMMENT ON COLUMN dsco_warehouse_sync.updated_at IS '更新时间（UTC 秒级时间戳）';
```
