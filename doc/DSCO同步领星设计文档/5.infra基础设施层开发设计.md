# 第五章 infra 基础设施层开发设计

本文基于：

- `doc/DSCO同步领星设计文档/1.业务需求.md`
- `doc/DSCO同步领星设计文档/2.架构设计.md`
- `doc/DSCO同步领星设计文档/3.数据库设计.md`
- `doc/DSCO同步领星设计文档/4.配置设计.md`

目标：把 **infra 层应该实现哪些包/文件、提供哪些能力、对上层暴露哪些“最小可用 API”、以及关键实现口径** 写清楚，便于后续按文档重构落地。

## 1. infra 层定位与边界（写死）

infra 层只做“基础设施”，不写任何 DSCO/领星业务规则与字段映射逻辑，典型职责：

- 启动配置读取：`env.yaml` + 环境变量覆盖
- DB 初始化：PostgreSQL + GORM（优先复用 `golibv2/v2/tool/db/gormx`）
- 运行时配置持久化：`runtime_config` 表（JSONB）
- 数据访问层（DAO）：`dsco_order_sync`、`dsco_warehouse_sync` 等表的 CRUD/查询/导出
- 互斥锁：同一任务不并发执行（使用 PostgreSQL advisory lock，不建锁表）
- 导出文件落地：CSV 生成、落地目录管理、目录大小统计（供清理任务使用）
- 导出审计文件落地：运行时配置补丁类任务（如 `pull_sku_pair`）落盘 old/new/diff 审计文件，统一落在 `admin.export.dir` 下并由 `cleanup_exports` 定时清理，避免磁盘爆炸

infra 层不做的事：

- 不负责“任务编排”（由 `integration/runner.go` 负责样板：快照/互斥/调用任务）
- 不负责“协议层触发”（HTTP/Scheduler 属于 `transport/*` 与 `admin/*`）
- 不负责“配置页面/接口”（Admin UI/API 属于 `admin/*`）

## 2. 目录结构（精确到文件，注释即职责与依赖）

> 说明：本章只定义 infra 目录；上层调用关系见 `doc/DSCO同步领星设计文档/2.架构设计.md`。

```text
infra/
├── config/
│   ├── envyaml.go                 # 读取 env.yaml（并支持 env 覆盖）；输出 EnvConfig
│   ├── env_types.go               # env.yaml 结构体：base/auth/integration/db/admin/log
│   ├── env_override.go            # 环境变量覆盖规则（同名覆盖，支持分组前缀）
│   └── env_validate.go            # 启动配置校验（缺项/非法直接启动失败）
│
├── runtimecfg/
│   ├── types.go                   # runtime_config.config JSON 结构体：domain/jobs/mapping
│   ├── validate.go                # 运行时配置校验：cron/size/job 名称白名单/mapping 规则等
│   ├── manager.go                 # 运行时配置管理：从 DB 读当前配置；Admin 更新后原子替换；提供快照
│   └── errors.go                  # 运行时配置相关错误（用于 API 返回与日志分类）
│
├── db/
│   └── postgres.go                # PostgreSQL 初始化：使用 gormx.Config 创建 *gorm.DB，暴露 Close
│
├── lock/
│   ├── advisory.go                # PostgreSQL advisory lock：try lock/unlock（按 JobName 生成 key）
│   └── key.go                     # JobName -> int64 lock key（稳定哈希算法，跨进程一致）
│
├── store/
│   ├── runtime_config_store.go     # runtime_config：Load/Upsert(domain, config, updated_at)
│   ├── dsco_order_sync_store.go    # dsco_order_sync：upsert(po_number 唯一)、条件查询、导出扫描
│   └── dsco_warehouse_sync_store.go# dsco_warehouse_sync：写入、条件查询、导出扫描
│
└── export/
    ├── csv_writer.go              # CSV 文件生成：写 temp -> fsync -> rename，避免半文件
    ├── file_naming.go             # 导出文件命名：前缀/时间/随机数，便于排查与清理
    ├── dir_size.go                # 目录大小统计（递归）；按 admin.export.cleanup_threshold_bytes 判断
    └── cleanup.go                 # 清理策略：总大小超阈值时按“最旧优先”删除
```

## 3. env.yaml 启动配置（infra/config）

### 3.1 目标

- 读取根目录 `env.yaml`，再用环境变量覆盖同名字段（便于部署/容器化）
- 输出一份强类型配置 `EnvConfig` 给 `main.go` 使用
- 对关键项做启动前校验：缺项/非法直接退出（禁止带病启动）

### 3.2 EnvConfig 结构（与第四章一致）

以 `doc/DSCO同步领星设计文档/4.配置设计.md` 为准，顶层分组：

- `base`：监听地址、环境（dev/test/release）
- `auth`：长期有效密钥（DSCO token、领星 app_id/app_secret）
- `integration`：集成固定配置（DSCO/领星 endpoint 可选覆盖、领星 platform_code 等）
- `db`：对齐 `golibv2/v2/tool/db/gormx.Config`
- `admin`：后台单密码、展示时区、导出目录与阈值
- `log`：对齐 `golibv2/v2/tool/logger.Config`

### 3.3 环境变量覆盖规则（建议）

文档层面把规则写死，避免实现与运维使用跑偏：

- 覆盖优先级：`env var` > `env.yaml`
- 只允许覆盖“同名字段”，不支持动态 key（避免不可控）
- 建议环境变量统一前缀：`IPASS_`（示例：`IPASS_BASE_LISTEN_ADDR`、`IPASS_ADMIN_PASSWORD`）
- 对 `db.dsn` 这类敏感字段，允许单字段覆盖（不要求覆盖整段 postgres 配置）

> 说明：具体命名可在落地代码时统一，但必须保证：可预测、可文档化、可回滚。

## 4. 运行时配置（infra/runtimecfg + infra/store/runtime_config）

### 4.1 数据来源与一致性

- 来源：PostgreSQL 表 `runtime_config`（详见第三章）
- 一期 domain：`dsco_lingxing`
- 一致性（写死）：任务执行前，runner 从 `runtimecfg.Manager` 获取一次“配置快照”；本次执行全程使用该快照；Admin 更新仅影响下一次执行。

### 4.2 数据结构（强类型 + JSONB）

`runtime_config.config` 的 JSON 结构以第四章为准，核心字段：

- `domain`：业务领域标识（分区/路由）
- `jobs`：任务调度（cron）+ 单次处理上限（size）
- `mapping`：shop/warehouse/sku/shipment 映射

### 4.3 校验规则（保存时必须校验）

`runtimecfg.Validate(cfg)` 需要覆盖以下规则（与第四章一致，并补齐实现口径）：

- JSON 可反序列化为强类型结构；必填字段存在
- `domain` 仅允许 `dsco_lingxing`
- `jobs`：
  - 只允许出现已支持的 job 名称（白名单来自 `integration/registry.go`，或 runtimecfg 内部常量表）
  - `cron` 必须能被解析（UTC）；要求支持 **6 段（含秒）** 格式
  - `size` 必须为正整数
- `mapping`：
  - key/value 一律按字符串处理（包含 WID 这类数字）
  - `mapping.warehouse`：在启用库存相关任务时必须非空

### 4.4 Manager 对上层暴露的最小 API（建议）

`runtimecfg.Manager` 作为“当前生效配置”的唯一入口，建议仅暴露以下方法：

- `LoadOrInit(domain string) error`
  - 启动时调用：若 DB 无数据，则写入默认配置（任务全关、mapping 为空）
- `Snapshot(domain string) (RuntimeConfig, bool)`
  - runner 调用：获取当前内存快照；不存在则返回 `false`
- `Update(domain string, newCfg RuntimeConfig) error`
  - admin 调用：校验 -> 写 DB -> 原子替换内存“当前配置”

> 说明：`Manager` 本身不做“任务触发/编排”，只负责配置一致性与热更新快照管理。

## 5. DB 初始化（infra/db）

### 5.1 目标

- 复用 `golibv2/v2/tool/db/gormx` 创建 PostgreSQL 的 `*gorm.DB`
- 统一连接池/日志策略，避免项目内重复封装
- 对外提供关闭能力：仅在入口处使用 `gdb.DB()` 获取底层连接并 `Close()`（符合约束）

### 5.2 初始化约束

- 禁止运行时 AutoMigrate/隐式改表
- 启动时可选 DB 连通性检查（由 `db.startupCheck.enabled` 控制）

## 6. 数据访问层（infra/store）

### 6.1 目标

- 所有 CRUD/查询/导出都收口在 store，业务/handler 不直接写 SQL
- 允许使用 GORM 的 `Raw/Exec/Transaction` 写“语义明确”的 SQL（避免 ORM 魔法）

### 6.2 runtime_config_store（当前生效配置）

表：`runtime_config`

- `Load(domain)`：读出 `config(jsonb)` 与 `updated_at(bigint)`，并反序列化
- `Upsert(domain, config, updated_at)`：更新当前生效配置（同 domain 仅一条记录）

时间字段口径：

- 所有时间类字段（如 `updated_at`）在 DB 中均为 `bigint`（UTC 秒级时间戳）

### 6.3 dsco_order_sync_store（订单同步状态）

表：`dsco_order_sync`

典型能力：

- Upsert：按 `po_number` 唯一；Admin 手动拉单允许覆盖 payload 与 status（业务需求已确认）
- 条件查询：按多个字段过滤（供 Admin 列表页）
- 导出扫描：按查询条件流式扫描写 CSV（避免一次性全量加载）

### 6.4 dsco_warehouse_sync_store（库存同步日志/结果）

表：`dsco_warehouse_sync`

典型能力：

- 写入：每次库存同步写入一条记录（用于 Admin 查询/导出）
- 条件查询/导出：同上

> 说明：不落地任务运行记录与配置审计（按业务确认，仅靠日志）；因此 infra/store 中不包含 `job_run` 与 `runtime_config_audit`。

## 7. 任务互斥锁（infra/lock：PostgreSQL advisory lock）

### 7.1 目标

- 同一任务（job）不允许并发执行（定时/手动共享互斥）
- 不引入锁表，不产生额外数据量与清理成本

### 7.2 锁实现口径

建议使用 PostgreSQL advisory lock：

- 申请：`pg_try_advisory_lock(bigint)`
- 释放：`pg_advisory_unlock(bigint)`

锁 key 生成要求（写死）：

- 同一 job 名称在不同进程/不同机器上生成相同 key
- 建议：对 `domain + ":" + jobName` 做稳定哈希（例如 FNV-1a 64），截断/转换为 `int64`

锁行为：

- try-lock 失败：立即返回“任务运行中”，不阻塞等待
- 正常结束或异常：必须保证 unlock（defer 释放；或使用 session 级锁并确保连接生命周期可控）

## 8. CSV 导出与文件落地（infra/export）

### 8.1 目标与约束

- 导出策略：生成 CSV 文件并立即下载（业务需求已确认）
- 导出时间范围：最多 1 年（由 `admin.export.max_range_days` 限制）
- 文件落地目录：`admin.export.dir`（部署机器本地磁盘）
- 清理策略：由 `integration/ops/cleanup_exports.go` 定时清理；目录总大小超过 `admin.export.cleanup_threshold_bytes`（100MB）触发，按最旧优先删除

### 8.2 写文件口径（避免半文件）

生成 CSV 必须使用“临时文件 + 原子替换”：

1) 在导出目录创建临时文件（如 `xxx.csv.tmp`）
2) 写入 CSV 内容并 `Flush`
3) 关闭文件（确保落盘）
4) `Rename` 为目标文件名（保证最终文件要么不存在，要么完整）

### 8.3 文件命名建议

建议命名携带可排查信息（不包含敏感字段）：

- `<prefix>_<yyyyMMddHHmmss>_<rand>.csv`
- prefix 示例：`dsco_order_sync`、`dsco_warehouse_sync`

## 9. 依赖关系（infra 对上层的最小暴露）

为了减少“到处 import infra/store 并拼业务逻辑”的坏味道，infra 尽量做到：

- 只导出必要的构造函数与方法；其余类型/字段保持非导出（小写）
- 上层按职责依赖：
  - `main.go`：依赖 `infra/config`、`infra/db`、`infra/runtimecfg`
  - `integration/runner.go`：依赖 `infra/runtimecfg`（快照）与 `infra/lock`（互斥）
  - 具体任务：依赖 `infra/store/*`（仅做数据读写）与 `golibv2/v2/sdk/*` client（外部对接）
  - `admin/*`：依赖 `infra/runtimecfg`（读写配置）与 `infra/store/*`（列表/导出）

> 说明：infra 不引入 interface 作为“预留扩展”——一期保持简单，等真实有多个实现时再引入抽象。
