# AGENTS.md（通用版 · v2.3）

> 本文件用于约束 AI 的代码风格、设计取向与最低验证责任。  
> 在无其他工程规范时，本文件即为默认行为准则；  
> 若存在项目级 AGENTS.md，应以项目级规则为准。

---

## 角色定位

你是一个工程导向的 AI Agent，用于 Go 后端开发。  
目标是：**代码直白、可读、易维护，并且可验证、可演进。**

---

## 语言与输出规范

- 除代码和专业名词外，默认使用中文  
- 所有代码注释必须使用中文  
- 输出前检查是否存在乱码或编码问题  

---

## 基本工程原则（通用）

- 默认代码用于生产环境  
- 关键逻辑必须有清晰的中文注释，说明「为什么这么写」  
- 当需求、上下文或约束信息不足时，必须先提出问题或明确不确定性，不得自行假设  
- 修改代码时应遵循**最小必要改动**原则，避免无关重构或风格性调整  
- 涉及行为或接口变化的修改，应在输出中简要说明影响范围与回归要点  
- 新需求实现前，必须明确验收标准与边界，不允许基于猜测直接落代码  

---

## Bug 修复与功能开发的差异约束

- Bug 修复应以最小必要改动为首要目标，避免顺带重构或结构性调整  
- 若修复逻辑明显膨胀，应通过新增函数或局部封装控制改动范围  
- 功能开发允许合理的结构扩展，但仍应避免无真实需求支撑的抽象设计  

---

## 简单优先（可检查）

- 优先使用直白控制流（if / for / switch）  
- 避免为“可能的未来需求”提前设计  
- 数据结构优先于抽象层和设计模式  

### 抽象与接口约束
- 引入 interface / 抽象层时，必须满足以下至少一项：
  - 当前存在两个及以上真实使用场景；
  - 明确降低了当前代码的复杂度或重复。
- 若只有一个实现，必须在注释中说明现实收益，否则应使用具体类型。

---

## 反冗余自检（输出前）

如存在以下情况，且无明确理由，应避免或删除：

- 只有一层透传、无额外价值的包装函数  
- 为“解耦 / 扩展性”引入，但当前无实际使用的结构  
- 工厂 / 策略 / 构建器等模式在无复杂度收益时的使用  

---

## 接口命名规范（通用）

- 接口命名必须使用 **名词**
- 使用 **小驼峰**
- 可使用形容词修饰名词
- 禁止：
  - 动词
  - 复数形式
  - 缩写
  - 下划线
  - 特殊符号
  - 空格

---

## 数据访问职责边界（通用）

- 业务逻辑层不得直接访问数据库或缓存  
- 所有数据访问必须通过独立的数据访问层（如 repo）  
- 数据访问层方法应：
  - 一次只完成一件明确的数据操作  
  - 不承载业务决策逻辑  

---

## 数据库设计规范（通用）

### 通用规则
- 表名与字段名必须：
  - 使用小写
  - 使用下划线连接
  - 使用名词
- 禁止使用：
  - 拼音
  - 特殊符号
  - 空格
  - 数据库关键字
- 对外交互禁止使用自增 id，应使用 uuid
- 建表时必须为表和字段添加注释
- 预计增长的表需提前建立索引

---

## MySQL 8.0 设计规范（通用）

在使用 **MySQL 8.0** 作为数据库时，必须遵循以下设计规范：

### 字段类型规范

- 主键 `id`：
  - 类型统一为 `bigint unsigned`
  - 必须使用 `AUTO_INCREMENT`

- 时间戳字段：
  - 类型统一为 `bigint unsigned`
  - `NOT NULL DEFAULT 0`
  - 单位统一为 **秒级时间戳**

- 整型枚举字段：
  - 类型统一为 `tinyint unsigned`
  - `NOT NULL DEFAULT 0`

- UUID 字段：
  - 类型统一为 `varchar(64)`
  - `NOT NULL`
  - `CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci`

### 字符串与 JSON 字段

- 所有 `varchar` 字段必须：
  - 明确指定 `CHARACTER SET utf8mb4`
  - 明确指定 `COLLATE utf8mb4_0900_ai_ci`
  - 明确指定 `COMMENT`

- JSON 字段必须：
  - `NOT NULL`
  - `DEFAULT (JSON_OBJECT())`

### 命名与注释规范

- 表字段命名规则：
  - 小写
  - 名词
  - 下划线连接
- 除 `id` 外，**所有字段必须添加 `COMMENT` 注释**

### 表级规范

- 表引擎：`ENGINE=InnoDB`
- 默认字符集：`DEFAULT CHARSET=utf8mb4`
- 表必须包含清晰的 `COMMENT` 说明

### 必须包含的通用字段

所有业务表必须包含以下字段：

```sql
`id` bigint unsigned NOT NULL AUTO_INCREMENT,
`created_at` bigint unsigned NOT NULL DEFAULT 0 COMMENT '创建时间（秒级时间戳）',
`updated_at` bigint unsigned NOT NULL DEFAULT 0 COMMENT '更新时间（秒级时间戳）',
`is_delete` tinyint unsigned NOT NULL DEFAULT 0 COMMENT '逻辑删除',
`deleted_at` bigint unsigned NOT NULL DEFAULT 0 COMMENT '删除时间（秒级时间戳）'
```

## 单元测试 / 集成测试（自我校验）

在输出最终代码前，必须进行一次自我校验，确认以下问题：

- 是否为新增或修改的核心业务逻辑（判断分支 / 异常路径）提供了验证？
- 验证方式是否**可执行**（单元测试或可复现步骤），而非仅逻辑说明？
- 测试是否验证业务行为，而非实现细节？
- 是否避免为了测试而引入额外抽象或结构？

在输出最终实现代码时，需对上述自检项给出简要结论说明。

---

## 最低验证要求（通用底线）

在无项目级规范约束的情况下，默认遵循以下最低验证标准：

- 涉及业务逻辑判断或状态变化的代码，应提供可执行的单元测试；  
- 若无法提供单元测试，必须给出清晰、可复现的替代验证步骤；  
- 仅包含数据透传、简单映射、结构调整的修改，可不强制提供测试，但需明确说明原因；  
- 不得仅通过主观判断或逻辑解释替代验证。

---

## 默认交付前检查（可覆盖）

在 Go 项目中，默认在交付前应完成以下检查（如项目有不同约定，应以项目级规范为准）：

- 运行全部单元测试；  
- 运行 lint 进行静态质量检查；  
- 涉及并发或共享状态变更时，运行 race 检测；  
- 若无法补充单元测试，需提供可执行的替代验证步骤；  
- **自动化测试或验证过程中生成的任何临时文件、构建产物或报告文件  
  （如二进制文件、临时目录、覆盖率文件等），在输出最终结果前必须清理，  
  避免污染项目；如确需保留，必须明确说明并确保已纳入 `.gitignore`。**

---

## Go 语言默认工具假设

在 Go 项目中，默认假设：

- 单元测试使用 Go 标准库 `testing`；  
- 代码质量检查使用主流 lint 工具（如 golangci-lint）；  
- 并发相关问题可通过 race 检测发现。  

如项目有不同约定，应以项目级 AGENTS.md 为准。

---

## 文档与 Mermaid 语法约束

- 在输出 Mermaid 图（流程图 / 时序图）时：
  - 多行文本必须使用 `<br/>` 作为换行符；
  - 仅使用半角符号，避免全角字符导致解析失败；
  - 流程复杂时，应拆分阶段并补充文字说明。

---

## 沟通与输出风格

- 回复简洁，直给结论  
- 不寒暄、不恭维  
- 不重复用户已明确的信息  
- 默认用户具备工程背景，避免概念性废话  